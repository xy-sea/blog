## å‰è¨€

å¸¸å¸¸ä¼šè‹¦æ¼ï¼Œå¹³å¸¸åšçš„é¡¹ç›®å¾ˆæ™®é€šï¼Œæ²¡å•¥äº®ç‚¹ï¼›é¢è¯•ä¸­ä¹Ÿç»å¸¸ä¼šè¢«é—®åˆ°ï¼šåšè¿‡å“ªäº›äº®ç‚¹é¡¹ç›®å—ï¼Ÿ

å‰ç«¯ç›‘æ§å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰äº®ç‚¹çš„é¡¹ç›®ï¼Œå„ä¸ªå¤§å‚éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨å®ç°ï¼Œæ²¡æœ‰ç›‘æ§çš„é¡¹ç›®å¥½æ¯”æ˜¯åœ¨è£¸å¥”

æ–‡ç« åˆ†æˆä»¥ä¸‹å…­éƒ¨åˆ†æ¥ä»‹ç»ï¼š

- è‡ªç ”ç›‘æ§å¹³å°è§£å†³äº†å“ªäº›ç—›ç‚¹ï¼Œå®ç°äº†ä»€ä¹ˆäº®ç‚¹åŠŸèƒ½ï¼Ÿ

- ç›¸æ¯” sentry ç­‰ç›‘æ§æ–¹æ¡ˆï¼Œè‡ªç ”ç›‘æ§çš„ä¼˜åŠ¿æœ‰å“ªäº›ï¼Ÿ

- å‰ç«¯ç›‘æ§çš„è®¾è®¡æ–¹æ¡ˆã€ç›‘æ§çš„ç›®çš„

- æ•°æ®çš„é‡‡é›†æ–¹å¼ï¼šé”™è¯¯ä¿¡æ¯ã€æ€§èƒ½æ•°æ®ã€ç”¨æˆ·è¡Œä¸ºã€åŠ è½½èµ„æºã€ä¸ªæ€§åŒ–æŒ‡æ ‡ç­‰
- è®¾è®¡å¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§ SDK

- ç›‘æ§åå°é”™è¯¯è¿˜åŸæ¼”ç¤ºç¤ºä¾‹

## ç—›ç‚¹

æŸâ¼€å¤©ç”¨æˆ·ï¼šxx å•†å“æ— æ³•ä¸‹å•ï¼  
â¼œâ¼€å¤©è¿è¥ï¼šxx å¹¿å‘Šåœ¨æ‰‹æœºç«¯æ‰“å¼€ä¸äº†ï¼

å¤§å®¶åé¦ˆçš„ bugï¼Œæ€ä¹ˆéƒ½å¤ç°ä¸å‡ºæ¥ï¼Œå°´å°¬çš„è¦æ­»ï¼ğŸ˜¢

å¦‚ä½•è®°å½•é¡¹ç›®çš„é”™è¯¯ï¼Œå¹¶å°†é”™è¯¯è¿˜åŸå‡ºæ¥ï¼Œè¿™æ˜¯ç›‘æ§å¹³å°è¦è§£å†³çš„ç—›ç‚¹ä¹‹ä¸€

## é”™è¯¯è¿˜åŸ

[web-see](https://github.com/xy-sea/web-see) ç›‘æ§æä¾›ä¸‰ç§é”™è¯¯è¿˜åŸæ–¹å¼ï¼šå®šä½æºç ã€æ’­æ”¾å½•å±ã€è®°å½•ç”¨æˆ·è¡Œä¸º

### å®šä½æºç 

é¡¹ç›®å‡ºé”™ï¼Œè¦æ˜¯èƒ½å®šä½åˆ°æºç å°±å¥½äº†ï¼Œå¯çº¿ä¸Šçš„é¡¹ç›®éƒ½æ˜¯æ‰“åŒ…åçš„ä»£ç ï¼Œä¹Ÿä¸èƒ½æŠŠ .map æ–‡ä»¶æ”¾åˆ°çº¿ä¸Š

ç›‘æ§å¹³å°é€šè¿‡ [source-map](https://github.com/mozilla/source-map) å¯ä»¥å®ç°è¯¥åŠŸèƒ½

æœ€ç»ˆæ•ˆæœï¼š

![errorCode.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/026bbc81cf4843b6a0671c89a52e8513~tplv-k3u1fbpfcp-watermark.image?)

### æ’­æ”¾å½•å±

å¤šæ•°åœºæ™¯ä¸‹ï¼Œå®šä½åˆ°å…·ä½“çš„æºç ï¼Œå°±å¯ä»¥å®šä½ bugï¼Œä½†å¦‚æœæ˜¯ç”¨æˆ·åšäº†å¼‚å¸¸æ“ä½œï¼Œæˆ–è€…æ˜¯åœ¨æŸäº›å¤æ‚æ“ä½œä¸‹æ‰å‡ºç°çš„ bugï¼Œä»…ä»…é€šè¿‡å®šä½æºç ï¼Œè¿˜æ˜¯ä¸èƒ½è¿˜åŸé”™è¯¯

è¦æ˜¯èƒ½æŠŠç”¨æˆ·çš„æ“ä½œéƒ½å½•åˆ¶ä¸‹æ¥ï¼Œç„¶åé€šè¿‡å›æ”¾æ¥è¿˜åŸé”™è¯¯å°±å¥½äº†

ç›‘æ§å¹³å°é€šè¿‡ [rrweb](https://github.com/rrweb-io/rrweb) å¯ä»¥å®ç°è¯¥åŠŸèƒ½

æœ€ç»ˆæ•ˆæœï¼š
![record.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0eb30a82a89e457182b9fde875757e80~tplv-k3u1fbpfcp-watermark.image?)

å›æ”¾çš„å½•å±ä¸­ï¼Œè®°å½•äº†ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œï¼Œçº¢è‰²çš„çº¿ä»£è¡¨äº†é¼ æ ‡çš„ç§»åŠ¨è½¨è¿¹

å‰ç«¯å½•å±ç¡®å®æ˜¯ä»¶å¾ˆé…·çš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸èƒ½èµ°æç«¯ï¼Œå¦‚æœæŠŠç”¨æˆ·çš„æ‰€æœ‰æ“ä½œéƒ½å½•åˆ¶ä¸‹æ¥ï¼Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„

æˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯ï¼Œé¡µé¢æŠ¥é”™çš„æ—¶å€™ç”¨æˆ·åšäº†å“ªäº›æ“ä½œï¼Œæ‰€ä»¥ç›‘æ§å¹³å°åªæŠŠæŠ¥é”™å‰ 10s çš„è§†é¢‘ä¿å­˜ä¸‹æ¥ï¼ˆå•æ¬¡å½•å±æ—¶é•¿ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼‰

### è®°å½•ç”¨æˆ·è¡Œä¸º

é€šè¿‡ å®šä½æºç  + æ’­æ”¾å½•å± è¿™å¥—ç»„åˆï¼Œè¿˜åŸé”™è¯¯åº”è¯¥å¤Ÿç”¨äº†ï¼ŒåŒæ—¶ç›‘æ§å¹³å°ä¹Ÿæä¾›äº† è®°å½•ç”¨æˆ·è¡Œä¸º è¿™ç§æ–¹å¼

å‡å¦‚ç”¨æˆ·åšäº†å¾ˆå¤šæ“ä½œï¼Œæ“ä½œçš„é—´éš”è¶…è¿‡äº†å•æ¬¡å½•å±æ—¶é•¿ï¼Œå½•åˆ¶çš„è§†é¢‘å¯èƒ½æ˜¯ä¸å®Œæ•´çš„ï¼Œæ­¤æ—¶å¯ä»¥å€ŸåŠ©ç”¨æˆ·è¡Œä¸ºæ¥åˆ†æç”¨æˆ·çš„æ“ä½œï¼Œå¸®åŠ©å¤ç° bug

æœ€ç»ˆæ•ˆæœï¼š
![userlist.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30f7c0f6e99d4f1d81def0c37a86e1ca~tplv-k3u1fbpfcp-watermark.image?)

ç”¨æˆ·è¡Œä¸ºåˆ—è¡¨è®°å½•äº†ï¼šé¼ æ ‡ç‚¹å‡»ã€æ¥å£è°ƒç”¨ã€èµ„æºåŠ è½½ã€é¡µé¢è·¯ç”±å˜åŒ–ã€ä»£ç æŠ¥é”™ç­‰ä¿¡æ¯

é€šè¿‡ `å®šä½æºç ã€æ’­æ”¾å½•å±ã€è®°å½•ç”¨æˆ·è¡Œä¸º` è¿™ä¸‰æ¿æ–§ï¼Œè§£å†³äº†å¤ç° bug çš„ç—›ç‚¹

## è‡ªç ”ç›‘æ§çš„ä¼˜åŠ¿

ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ sentry ç§æœ‰åŒ–éƒ¨ç½²ï¼Œè€Œé€‰æ‹©è‡ªç ”å‰ç«¯ç›‘æ§ï¼Ÿ

è¿™æ˜¯ä¼˜å…ˆè¦æ€è€ƒçš„é—®é¢˜ï¼Œsentry ä½œä¸ºå‰ç«¯ç›‘æ§çš„è¡Œä¸šæ ‡æ†ï¼Œæœ‰å¾ˆå¤šå¯ä»¥å€Ÿé‰´çš„åœ°æ–¹

ç›¸æ¯” sentryï¼Œè‡ªç ”ç›‘æ§å¹³å°çš„ä¼˜åŠ¿åœ¨äºï¼š

1ã€å¯ä»¥å°†å…¬å¸çš„ SDK ç»Ÿä¸€æˆä¸€ä¸ªï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šç›‘æ§ SDKã€åŸ‹ç‚¹ SDKã€å½•å± SDKã€å¹¿å‘Š SDK ç­‰

2ã€æä¾›äº†æ›´å¤šçš„é”™è¯¯è¿˜åŸæ–¹å¼ï¼ŒåŒæ—¶é”™è¯¯ä¿¡æ¯å¯ä»¥å’ŒåŸ‹ç‚¹ä¿¡æ¯è”åŠ¨ï¼Œä¾¿å¯æ‹¿åˆ°æ›´ç»†è‡´çš„ç”¨æˆ·è¡Œä¸ºæ ˆï¼Œæ›´å¿«çš„æ’æŸ¥çº¿ä¸Šé”™è¯¯

3ã€ç›‘æ§è‡ªå®šä¹‰çš„ä¸ªæ€§åŒ–æŒ‡æ ‡ï¼šå¦‚ long taskã€memory é¡µé¢å†…å­˜ã€é¦–å±åŠ è½½æ—¶é—´ç­‰ã€‚è¿‡å¤šçš„é•¿ä»»åŠ¡ä¼šé€ æˆé¡µé¢ä¸¢å¸§ã€å¡é¡¿ï¼›è¿‡å¤§çš„å†…å­˜å¯èƒ½ä¼šé€ æˆä½ç«¯æœºå™¨çš„å¡æ­»ã€å´©æºƒ

4ã€ç»Ÿè®¡èµ„æºç¼“å­˜ç‡ï¼Œæ¥åˆ¤æ–­é¡¹ç›®çš„ç¼“å­˜ç­–ç•¥æ˜¯å¦åˆç†ï¼Œæå‡ç¼“å­˜ç‡å¯ä»¥å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œä¹Ÿå¯ä»¥æå‡é¡µé¢çš„æ‰“å¼€é€Ÿåº¦

5ã€æä¾›äº† Â **é‡‡æ ·å¯¹æ¯”+ è½®è¯¢ä¿®æ­£æœºåˆ¶**Â  çš„ç™½å±æ£€æµ‹æ–¹æ¡ˆï¼Œç”¨äºæ£€æµ‹é¡µé¢æ˜¯å¦ä¸€ç›´å¤„äºç™½å±çŠ¶æ€ï¼Œè®©å¼€å‘è€…çŸ¥é“é¡µé¢ä»€ä¹ˆæ—¶å€™ç™½äº†ï¼Œå…·ä½“å®ç°è§ [å‰ç«¯ç™½å±çš„æ£€æµ‹æ–¹æ¡ˆï¼Œè§£å†³ä½ çš„çº¿ä¸Šä¹‹å¿§](https://juejin.cn/post/7176206226903007292)

## è®¾è®¡æ€è·¯

ä¸€ä¸ªå®Œæ•´çš„å‰ç«¯ç›‘æ§å¹³å°åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥ã€æ•°æ®åˆ†æå’Œå­˜å‚¨ã€æ•°æ®å±•ç¤º

![system.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2111ab12f74546a9b570ea8f5fd52cc9~tplv-k3u1fbpfcp-watermark.image?)

### ç›‘æ§ç›®çš„

![title.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b17a43984e3945199c6c4fcad74ec6f6~tplv-k3u1fbpfcp-watermark.image?)

### å¼‚å¸¸åˆ†æ

æŒ‰ç…§ 5W1H æ³•åˆ™æ¥åˆ†æå‰ç«¯å¼‚å¸¸ï¼Œéœ€è¦çŸ¥é“ä»¥ä¸‹ä¿¡æ¯

1.  Whatï¼Œå‘â½£äº†ä»€ä¹ˆé”™è¯¯ï¼šJS é”™è¯¯ã€å¼‚æ­¥é”™è¯¯ã€èµ„æºåŠ è½½ã€æ¥å£é”™è¯¯ç­‰
2.  Whenï¼Œå‡ºç°çš„æ—¶é—´æ®µï¼Œå¦‚æ—¶é—´æˆ³
3.  Whoï¼Œå½±å“äº†å¤šå°‘ç”¨æˆ·ï¼ŒåŒ…æ‹¬æŠ¥é”™äº‹ä»¶æ•°ã€IP
4.  Whereï¼Œå‡ºç°çš„é¡µé¢æ˜¯å“ªäº›ï¼ŒåŒ…æ‹¬é¡µé¢ã€å¯¹åº”çš„è®¾å¤‡ä¿¡æ¯
5.  Whyï¼Œé”™è¯¯çš„åŸå› æ˜¯ä¸ºä»€ä¹ˆï¼ŒåŒ…æ‹¬é”™è¯¯å †æ ˆã€â¾åˆ—ã€SourceMapã€å¼‚å¸¸å½•å±
6.  Howï¼Œå¦‚ä½•å®šä½è¿˜åŸé—®é¢˜ï¼Œå¦‚ä½•å¼‚å¸¸æŠ¥è­¦ï¼Œé¿å…ç±»ä¼¼çš„é”™è¯¯å‘ç”Ÿ

## é”™è¯¯æ•°æ®é‡‡é›†

é”™è¯¯ä¿¡æ¯æ˜¯æœ€åŸºç¡€ä¹Ÿæ˜¯æœ€é‡è¦çš„æ•°æ®ï¼Œé”™è¯¯ä¿¡æ¯ä¸»è¦åˆ†ä¸ºä¸‹é¢å‡ ç±»ï¼š

- JS ä»£ç è¿è¡Œé”™è¯¯ã€è¯­æ³•é”™è¯¯ç­‰
- å¼‚æ­¥é”™è¯¯ç­‰
- é™æ€èµ„æºåŠ è½½é”™è¯¯
- æ¥å£è¯·æ±‚æŠ¥é”™

### é”™è¯¯æ•è·æ–¹å¼

1ï¼‰try/catch

åªèƒ½æ•è·ä»£ç å¸¸è§„çš„è¿è¡Œé”™è¯¯ï¼Œè¯­æ³•é”™è¯¯å’Œå¼‚æ­¥é”™è¯¯ä¸èƒ½æ•è·åˆ°

ç¤ºä¾‹ï¼š

```
// ç¤ºä¾‹1ï¼šå¸¸è§„è¿è¡Œæ—¶é”™è¯¯ï¼Œå¯ä»¥æ•è· âœ…
 try {
   let a = undefined;
   if (a.length) {
     console.log('111');
   }
 } catch (e) {
   console.log('æ•è·åˆ°å¼‚å¸¸ï¼š', e);
}

// ç¤ºä¾‹2ï¼šè¯­æ³•é”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
try {
  const notdefined,
} catch(e) {
  console.log('æ•è·ä¸åˆ°å¼‚å¸¸ï¼š', 'Uncaught SyntaxError');
}

// ç¤ºä¾‹3ï¼šå¼‚æ­¥é”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
try {
  setTimeout(() => {
    console.log(notdefined);
  }, 0)
} catch(e) {
  console.log('æ•è·ä¸åˆ°å¼‚å¸¸ï¼š', 'Uncaught ReferenceError');
}
```

2ï¼‰ window.onerror

window.onerror å¯ä»¥æ•è·å¸¸è§„é”™è¯¯ã€å¼‚æ­¥é”™è¯¯ï¼Œä½†ä¸èƒ½æ•è·èµ„æºé”™è¯¯

```
/**
* @param { string } message é”™è¯¯ä¿¡æ¯
* @param { string } source å‘ç”Ÿé”™è¯¯çš„è„šæœ¬URL
* @param { number } lineno å‘ç”Ÿé”™è¯¯çš„è¡Œå·
* @param { number } colno å‘ç”Ÿé”™è¯¯çš„åˆ—å·
* @param { object } error Errorå¯¹è±¡
*/
window.onerror = function(message, source, lineno, colno, error) {
   console.log('æ•è·åˆ°çš„é”™è¯¯ä¿¡æ¯æ˜¯ï¼š', message, source, lineno, colno, error )
}
```

ç¤ºä¾‹ï¼š

```
window.onerror = function(message, source, lineno, colno, error) {
  console.log("æ•è·åˆ°çš„é”™è¯¯ä¿¡æ¯æ˜¯ï¼š", message, source, lineno, colno, error);
};

// ç¤ºä¾‹1ï¼šå¸¸è§„è¿è¡Œæ—¶é”™è¯¯ï¼Œå¯ä»¥æ•è· âœ…
console.log(notdefined);

// ç¤ºä¾‹2ï¼šè¯­æ³•é”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
const notdefined;

// ç¤ºä¾‹3ï¼šå¼‚æ­¥é”™è¯¯ï¼Œå¯ä»¥æ•è· âœ…
setTimeout(() => {
  console.log(notdefined);
}, 0);

// ç¤ºä¾‹4ï¼šèµ„æºé”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
let script = document.createElement("script");
script.type = "text/javascript";
script.src = "https://www.test.com/index.js";
document.body.appendChild(script);
```

3ï¼‰ window.addEventListener

å½“é™æ€èµ„æºåŠ è½½å¤±è´¥æ—¶ï¼Œä¼šè§¦å‘ error äº‹ä»¶ï¼Œ æ­¤æ—¶ window.onerror ä¸èƒ½æ•è·åˆ°

ç¤ºä¾‹ï¼š

```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
</head>
<script>
  window.addEventListener('error', (error) => {
    console.log('æ•è·åˆ°å¼‚å¸¸ï¼š', error);
  }, true)
</script>

<!-- å›¾ç‰‡ã€scriptã€cssåŠ è½½é”™è¯¯ï¼Œéƒ½èƒ½è¢«æ•è· âœ… -->
<img src="https://test.cn/Ã—Ã—Ã—.png">
<script src="https://test.cn/Ã—Ã—Ã—.js"></script>
<link href="https://test.cn/Ã—Ã—Ã—.css" rel="stylesheet" />

<script>
  // new Imageé”™è¯¯ï¼Œä¸èƒ½æ•è· âŒ
  // new Imageè¿ç”¨çš„æ¯”è¾ƒå°‘ï¼Œå¯ä»¥è‡ªå·±å•ç‹¬å¤„ç†
  new Image().src = 'https://test.cn/Ã—Ã—Ã—.png'
</script>
</html>
```

4ï¼‰Promise é”™è¯¯

Promise ä¸­æŠ›å‡ºçš„é”™è¯¯ï¼Œæ— æ³•è¢« window.onerrorã€try/catchã€ error äº‹ä»¶æ•è·åˆ°ï¼Œå¯é€šè¿‡ unhandledrejection äº‹ä»¶æ¥å¤„ç†

ç¤ºä¾‹ï¼š

```
try {
  new Promise((resolve, reject) => {
    JSON.parse("");
    resolve();
  });
} catch (err) {
  // try/catch ä¸èƒ½æ•è·Promiseä¸­é”™è¯¯ âŒ
  console.error("in try catch", err);
}

// erroräº‹ä»¶ ä¸èƒ½æ•è·Promiseä¸­é”™è¯¯ âŒ
window.addEventListener(
  "error",
  error => {
    console.log("æ•è·åˆ°å¼‚å¸¸ï¼š", error);
  },
  true
);

// window.onerror ä¸èƒ½æ•è·Promiseä¸­é”™è¯¯ âŒ
window.onerror = function(message, source, lineno, colno, error) {
  console.log("æ•è·åˆ°å¼‚å¸¸ï¼š", { message, source, lineno, colno, error });
};

// unhandledrejection å¯ä»¥æ•è·Promiseä¸­çš„é”™è¯¯ âœ…
window.addEventListener("unhandledrejection", function(e) {
  console.log("æ•è·åˆ°å¼‚å¸¸", e);
  // preventDefaulté˜»æ­¢ä¼ æ’­ï¼Œä¸ä¼šåœ¨æ§åˆ¶å°æ‰“å°
  e.preventDefault();
});

```

### Vue é”™è¯¯

Vue é¡¹ç›®ä¸­ï¼Œwindow.onerror å’Œ error äº‹ä»¶ä¸èƒ½æ•è·åˆ°å¸¸è§„çš„ä»£ç é”™è¯¯

å¼‚å¸¸ä»£ç ï¼š

```
export default {
  created() {
    let a = null;
    if(a.length > 1) {
        // ...
    }
  }
};
```

main.js ä¸­æ·»åŠ æ•è·ä»£ç ï¼š

```
window.addEventListener('error', (error) => {
  console.log('error', error);
});
window.onerror = function (msg, url, line, col, error) {
  console.log('onerror', msg, url, line, col, error);
};
```

æ§åˆ¶å°ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ window.onerror å’Œ error ä¸èƒ½æ•è·åˆ°

![error.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a466fa1a02fb44b6b03f476a4bd066b1~tplv-k3u1fbpfcp-watermark.image?)

vue é€šè¿‡ Â `Vue.config.errorHander` æ¥æ•è·å¼‚å¸¸ï¼š

```
Vue.config.errorHandler = (err, vm, info) => {
    console.log('è¿›æ¥å•¦~', err);
}
```

æ§åˆ¶å°æ‰“å°:

![error2.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60cea7b4e84d4f699f11854feac23639~tplv-k3u1fbpfcp-watermark.image?)

**errorHandler æºç åˆ†æ**

åœ¨`src/core/util`ç›®å½•ä¸‹ï¼Œæœ‰ä¸€ä¸ª`error.js`æ–‡ä»¶

```
function globalHandleError (err, vm, info) {
  // è·å–å…¨å±€é…ç½®ï¼Œåˆ¤æ–­æ˜¯å¦è®¾ç½®å¤„ç†å‡½æ•°ï¼Œé»˜è®¤undefined
  // é…ç½®config.errorHandleræ–¹æ³•
  if (config.errorHandler) {
    try {
      // æ‰§è¡Œ errorHandler
      return config.errorHandler.call(null, err, vm, info)
    } catch (e) {
      // å¦‚æœå¼€å‘è€…åœ¨errorHandlerå‡½æ•°ä¸­ï¼Œæ‰‹åŠ¨æŠ›å‡ºåŒæ ·é”™è¯¯ä¿¡æ¯throw errï¼Œåˆ¤æ–­errä¿¡æ¯æ˜¯å¦ç›¸ç­‰ï¼Œé¿å…logä¸¤æ¬¡
      if (e !== err) {
        logError(e, null, 'config.errorHandler')
      }
    }
  }
  // æ²¡æœ‰é…ç½®ï¼Œå¸¸è§„è¾“å‡º
  logError(err, vm, info)
}

function logError (err, vm, info) {
  if (process.env.NODE_ENV !== 'production') {
    warn(`Error in ${info}: "${err.toString()}"`, vm)
  }
  /* istanbul ignore else */
  if ((inBrowser || inWeex) && typeof console !== 'undefined') {
    console.error(err)
  } else {
    throw err
  }
}
```

é€šè¿‡æºç æ˜ç™½äº†ï¼Œvue ä½¿ç”¨ try/catch æ¥æ•è·å¸¸è§„ä»£ç çš„æŠ¥é”™ï¼Œè¢«æ•è·çš„é”™è¯¯ä¼šé€šè¿‡ console.error è¾“å‡ºè€Œé¿å…åº”ç”¨å´©æºƒ

å¯ä»¥åœ¨ Vue.config.errorHandler ä¸­å°†æ•è·çš„é”™è¯¯ä¸ŠæŠ¥

```
Vue.config.errorHandler = function (err, vm, info) {
  // handleErroræ–¹æ³•ç”¨æ¥å¤„ç†é”™è¯¯å¹¶ä¸ŠæŠ¥
  handleError(err);
}
```

### React é”™è¯¯

ä» react16 å¼€å§‹ï¼Œå®˜æ–¹æä¾›äº† ErrorBoundary é”™è¯¯è¾¹ç•Œçš„åŠŸèƒ½ï¼Œè¢«è¯¥ç»„ä»¶åŒ…è£¹çš„å­ç»„ä»¶ï¼Œrender å‡½æ•°æŠ¥é”™æ—¶ä¼šè§¦å‘ç¦»å½“å‰ç»„ä»¶æœ€è¿‘çˆ¶ç»„ä»¶çš„ ErrorBoundary

ç”Ÿäº§ç¯å¢ƒï¼Œä¸€æ—¦è¢« ErrorBoundary æ•è·çš„é”™è¯¯ï¼Œä¹Ÿä¸ä¼šè§¦å‘å…¨å±€çš„ window.onerror å’Œ error äº‹ä»¶

çˆ¶ç»„ä»¶ä»£ç ï¼š

```
import React from 'react';
import Child from './Child.js';

// window.onerror ä¸èƒ½æ•è·renderå‡½æ•°çš„é”™è¯¯ âŒ
window.onerror = function (err, msg, c, l) {
  console.log('err', err, msg);
};

// error ä¸èƒ½renderå‡½æ•°çš„é”™è¯¯ âŒ
window.addEventListener( 'error', (error) => {
    console.log('æ•è·åˆ°å¼‚å¸¸ï¼š', error);
  },true
);

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    // æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“èƒ½å¤Ÿæ˜¾ç¤ºé™çº§åçš„ UI
    return { hasError: true };
  }
  componentDidCatch(error, errorInfo) {
    // componentDidCatch å¯ä»¥æ•è·renderå‡½æ•°çš„é”™è¯¯
    console.log(error, errorInfo)

    // åŒæ ·å¯ä»¥å°†é”™è¯¯æ—¥å¿—ä¸ŠæŠ¥ç»™æœåŠ¡å™¨
    reportError(error, errorInfo);
  }
  render() {
    if (this.state.hasError) {
      // è‡ªå®šä¹‰é™çº§åçš„ UI å¹¶æ¸²æŸ“
      return <h1>Something went wrong.</h1>;
    }
    return this.props.children;
  }
}

function Parent() {
  return (
    <div>
      çˆ¶ç»„ä»¶
      <ErrorBoundary>
        <Child />
      </ErrorBoundary>
    </div>
  );
}

export default Parent;
```

å­ç»„ä»¶ä»£ç ï¼š

```
// å­ç»„ä»¶ æ¸²æŸ“å‡ºé”™
function Child() {
  let list = {};
  return (
    <div>
      å­ç»„ä»¶
      {list.map((item, key) => (
        <span key={key}>{item}</span>
      ))}
    </div>
  );
}
export default Child;
```

åŒ vue é¡¹ç›®çš„å¤„ç†ç±»ä¼¼ï¼Œreact é¡¹ç›®ä¸­ï¼Œå¯ä»¥åœ¨ componentDidCatch ä¸­å°†æ•è·çš„é”™è¯¯ä¸ŠæŠ¥

```
componentDidCatch(error, errorInfo) {
  // handleErroræ–¹æ³•ç”¨æ¥å¤„ç†é”™è¯¯å¹¶ä¸ŠæŠ¥
  handleError(err);
}
```

### è·¨åŸŸé—®é¢˜

å¦‚æœå½“å‰é¡µé¢ä¸­ï¼Œå¼•å…¥äº†å…¶ä»–åŸŸåçš„ JS èµ„æºï¼Œå¦‚æœèµ„æºå‡ºç°é”™è¯¯ï¼Œerror äº‹ä»¶åªä¼šç›‘æµ‹åˆ°ä¸€ä¸ª Â `script error` çš„å¼‚å¸¸ã€‚

ç¤ºä¾‹ï¼š

```
window.addEventListener("error", error => {
  console.log("æ•è·åˆ°å¼‚å¸¸ï¼š", error);
}, true );

// å½“å‰é¡µé¢åŠ è½½å…¶ä»–åŸŸçš„èµ„æºï¼Œå¦‚https://www.test.com/index.js
<script src="https://www.test.com/index.js"></script>

// åŠ è½½çš„https://www.test.com/index.jsçš„ä»£ç 
function fn() {
  JSON.parse("");
}
fn();
```

æŠ¥é”™ä¿¡æ¯ï¼š

![scriptError.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d3a64682d05414e9e4c7a17a78895f4~tplv-k3u1fbpfcp-watermark.image?)

åªèƒ½æ•è·åˆ° `script error` çš„åŸå› ï¼š

æ˜¯ç”±äºæµè§ˆå™¨åŸºäº`å®‰å…¨è€ƒè™‘`ï¼Œæ•…æ„éšè—äº†å…¶å®ƒåŸŸ JS æ–‡ä»¶æŠ›å‡ºçš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé¿å…æ•æ„Ÿä¿¡æ¯æ— æ„ä¸­è¢«ç¬¬ä¸‰æ–¹(ä¸å—æ§åˆ¶çš„)è„šæœ¬æ•è·åˆ°ï¼Œå› æ­¤ï¼Œæµè§ˆå™¨åªå…è®¸åŒåŸŸä¸‹çš„è„šæœ¬æ•è·å…·ä½“çš„é”™è¯¯ä¿¡æ¯

è§£å†³æ–¹æ³•ï¼š

å‰ç«¯ script åŠ  crossoriginï¼Œåç«¯é…ç½® Access-Control-Allow-Origin

```
<script src="https://www.test.com/index.js" crossorigin></script>
```

æ·»åŠ  crossorigin åå¯ä»¥æ•è·åˆ°å®Œæ•´çš„æŠ¥é”™ä¿¡æ¯ï¼š

![ScriptError1.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f78998ae48140bebbae82ce6f073536~tplv-k3u1fbpfcp-watermark.image?)

å¦‚æœä¸èƒ½ä¿®æ”¹æœåŠ¡ç«¯çš„è¯·æ±‚å¤´ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ä½¿ç”¨ try/catch ç»•è¿‡ï¼Œå°†é”™è¯¯æŠ›å‡º

```
<!doctype html>
<html>
<body>
  <script src="https://www.test.com/index.js"></script>
  <script>
  window.addEventListener("error", error => {
    console.log("æ•è·åˆ°å¼‚å¸¸ï¼š", error);
  }, true );

  try {
    // è°ƒç”¨https://www.test.com/index.jsä¸­å®šä¹‰çš„fnæ–¹æ³•
    fn();
  } catch (e) {
    throw e;
  }
  </script>
</body>
</html>
```

### æ¥å£é”™è¯¯

æ¥å£ç›‘æ§çš„å®ç°åŸç†ï¼šé’ˆå¯¹æµè§ˆå™¨å†…ç½®çš„ XMLHttpRequestã€fetch å¯¹è±¡ï¼Œåˆ©ç”¨ AOP åˆ‡ç‰‡ç¼–ç¨‹é‡å†™è¯¥æ–¹æ³•ï¼Œå®ç°å¯¹è¯·æ±‚çš„æ¥å£æ‹¦æˆªï¼Œä»è€Œè·å–æ¥å£æŠ¥é”™çš„æƒ…å†µå¹¶ä¸ŠæŠ¥

1ï¼‰æ‹¦æˆª XMLHttpRequest è¯·æ±‚ç¤ºä¾‹ï¼š

```
function xhrReplace() {
  if (!("XMLHttpRequest" in window)) {
    return;
  }
  const originalXhrProto = XMLHttpRequest.prototype;
  // é‡å†™XMLHttpRequest åŸå‹ä¸Šçš„openæ–¹æ³•
  replaceAop(originalXhrProto, "open", originalOpen => {
    return function(...args) {
      // è·å–è¯·æ±‚çš„ä¿¡æ¯
      this._xhr = {
        method: typeof args[0] === "string" ? args[0].toUpperCase() : args[0],
        url: args[1],
        startTime: new Date().getTime(),
        type: "xhr"
      };
      // æ‰§è¡ŒåŸå§‹çš„openæ–¹æ³•
      originalOpen.apply(this, args);
    };
  });
  // é‡å†™XMLHttpRequest åŸå‹ä¸Šçš„sendæ–¹æ³•
  replaceAop(originalXhrProto, "send", originalSend => {
    return function(...args) {
      // å½“è¯·æ±‚ç»“æŸæ—¶è§¦å‘ï¼Œæ— è®ºè¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šè§¦å‘
      this.addEventListener("loadend", () => {
        const { responseType, response, status } = this;
        const endTime = new Date().getTime();
        this._xhr.reqData = args[0];
        this._xhr.status = status;
        if (["", "json", "text"].indexOf(responseType) !== -1) {
          this._xhr.responseText =
            typeof response === "object" ? JSON.stringify(response) : response;
        }
        // è·å–æ¥å£çš„è¯·æ±‚æ—¶é•¿
        this._xhr.elapsedTime = endTime - this._xhr.startTime;

        // ä¸ŠæŠ¥xhræ¥å£æ•°æ®
        reportData(this._xhr);
      });
      // æ‰§è¡ŒåŸå§‹çš„sendæ–¹æ³•
      originalSend.apply(this, args);
    };
  });
}

/**
 * é‡å†™æŒ‡å®šçš„æ–¹æ³•
 * @param { object } source é‡å†™çš„å¯¹è±¡
 * @param { string } name é‡å†™çš„å±æ€§
 * @param { function } fn æ‹¦æˆªçš„å‡½æ•°
 */
function replaceAop(source, name, fn) {
  if (source === undefined) return;
  if (name in source) {
    var original = source[name];
    var wrapped = fn(original);
    if (typeof wrapped === "function") {
      source[name] = wrapped;
    }
  }
}
```

2ï¼‰æ‹¦æˆª fetch è¯·æ±‚ç¤ºä¾‹ï¼š

```
function fetchReplace() {
  if (!("fetch" in window)) {
    return;
  }
  // é‡å†™fetchæ–¹æ³•
  replaceAop(window, "fetch", originalFetch => {
    return function(url, config) {
      const sTime = new Date().getTime();
      const method = (config && config.method) || "GET";
      let handlerData = {
        type: "fetch",
        method,
        reqData: config && config.body,
        url
      };

      return originalFetch.apply(window, [url, config]).then(
        res => {
          // res.cloneå…‹éš†ï¼Œé˜²æ­¢è¢«æ ‡è®°å·²æ¶ˆè´¹
          const tempRes = res.clone();
          const eTime = new Date().getTime();
          handlerData = {
            ...handlerData,
            elapsedTime: eTime - sTime,
            status: tempRes.status
          };
          tempRes.text().then(data => {
            handlerData.responseText = data;
            // ä¸ŠæŠ¥fetchæ¥å£æ•°æ®
            reportData(handlerData);
          });

          // è¿”å›åŸå§‹çš„ç»“æœï¼Œå¤–éƒ¨ç»§ç»­ä½¿ç”¨thenæ¥æ”¶
          return res;
        },
        err => {
          const eTime = new Date().getTime();
          handlerData = {
            ...handlerData,
            elapsedTime: eTime - sTime,
            status: 0
          };
          // ä¸ŠæŠ¥fetchæ¥å£æ•°æ®
          reportData(handlerData);
          throw err;
        }
      );
    };
  });
}
```

## æ€§èƒ½æ•°æ®é‡‡é›†

è°ˆåˆ°æ€§èƒ½æ•°æ®é‡‡é›†ï¼Œå°±ä¼šæåŠåŠ è½½è¿‡ç¨‹æ¨¡å‹å›¾ï¼š

![timing.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d47107de71349518cf4f43e6508fa3a~tplv-k3u1fbpfcp-watermark.image?)

ä»¥ Spa é¡µé¢æ¥è¯´ï¼Œé¡µé¢çš„åŠ è½½è¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š

![spa.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93ee1530332a432b904eb3f6af65cc7a~tplv-k3u1fbpfcp-watermark.image?)

åŒ…æ‹¬ dns æŸ¥è¯¢ã€å»ºç«‹ tcp è¿æ¥ã€å‘é€ http è¯·æ±‚ã€è¿”å› html æ–‡æ¡£ã€html æ–‡æ¡£è§£æç­‰é˜¶æ®µ

æœ€åˆï¼Œå¯ä»¥é€šè¿‡ Â `window.performance.timing`Â  æ¥è·å–åŠ è½½è¿‡ç¨‹æ¨¡å‹ä¸­å„ä¸ªé˜¶æ®µçš„è€—æ—¶æ•°æ®

```
// window.performance.timing å„å­—æ®µè¯´æ˜
{
    navigationStart,  // åŒä¸€ä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸Šä¸€ä¸ªæ–‡æ¡£ç»“æŸæ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    unloadEventStart,  // ä¸Šä¸€ä¸ªæ–‡æ¡£ unload äº‹ä»¶è§¦å‘æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œä¸º 0ã€‚
    unloadEventEnd, // ä¸Šä¸€ä¸ªæ–‡æ¡£ unload äº‹ä»¶ç»“æŸæ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œä¸º 0ã€‚
    redirectStart, // è¡¨ç¤ºç¬¬ä¸€ä¸ª http é‡å®šå‘å¼€å§‹æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰é‡å®šå‘æˆ–è€…æœ‰ä¸€ä¸ªéåŒæºçš„é‡å®šå‘ï¼Œä¸º 0ã€‚
    redirectEnd, // è¡¨ç¤ºæœ€åä¸€ä¸ª http é‡å®šå‘ç»“æŸæ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœæ²¡æœ‰é‡å®šå‘æˆ–è€…æœ‰ä¸€ä¸ªéåŒæºçš„é‡å®šå‘ï¼Œä¸º 0ã€‚
    fetchStart, // è¡¨ç¤ºæµè§ˆå™¨å‡†å¤‡å¥½ä½¿ç”¨ http è¯·æ±‚æ¥è·å–æ–‡æ¡£çš„æ—¶é—´æˆ³ã€‚è¿™ä¸ªæ—¶é—´ç‚¹ä¼šåœ¨æ£€æŸ¥ä»»ä½•ç¼“å­˜ä¹‹å‰ã€‚
    domainLookupStart, // åŸŸåæŸ¥è¯¢å¼€å§‹çš„æ—¶é—´æˆ³ã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥æˆ–è€…æœ¬åœ°æœ‰ç¼“å­˜ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    domainLookupEnd, // åŸŸåæŸ¥è¯¢ç»“æŸçš„æ—¶é—´æˆ³ã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥æˆ–è€…æœ¬åœ°æœ‰ç¼“å­˜ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    connectStart, // http è¯·æ±‚å‘æœåŠ¡å™¨å‘é€è¿æ¥è¯·æ±‚æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    connectEnd, // æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹å‰å»ºç«‹è¿æ¥çš„æ—¶é—´æˆ³ï¼Œæ‰€æœ‰æ¡æ‰‹å’Œè®¤è¯è¿‡ç¨‹å…¨éƒ¨ç»“æŸã€‚å¦‚æœä½¿ç”¨äº†æŒä¹…è¿æ¥ï¼Œè¿™ä¸ªå€¼ä¼šå’Œ fetchStart ç›¸åŒã€‚
    secureConnectionStart, // æµè§ˆå™¨ä¸æœåŠ¡å™¨å¼€å§‹å®‰å…¨é“¾æ¥çš„æ¡æ‰‹æ—¶çš„æ—¶é—´æˆ³ã€‚å¦‚æœå½“å‰ç½‘é¡µä¸è¦æ±‚å®‰å…¨è¿æ¥ï¼Œè¿”å› 0ã€‚
    requestStart, // æµè§ˆå™¨å‘æœåŠ¡å™¨å‘èµ· http è¯·æ±‚(æˆ–è€…è¯»å–æœ¬åœ°ç¼“å­˜)æ—¶çš„æ—¶é—´æˆ³ï¼Œå³è·å– html æ–‡æ¡£ã€‚
    responseStart, // æµè§ˆå™¨ä»æœåŠ¡å™¨æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚æ—¶çš„æ—¶é—´æˆ³ã€‚
    responseEnd, // æµè§ˆå™¨ä»æœåŠ¡å™¨æ¥å—åˆ°æœ€åä¸€ä¸ªå­—èŠ‚æ—¶çš„æ—¶é—´æˆ³ã€‚
    domLoading, // dom ç»“æ„å¼€å§‹è§£æçš„æ—¶é—´æˆ³ï¼Œdocument.readyState çš„å€¼ä¸º loadingã€‚
    domInteractive, // dom ç»“æ„è§£æç»“æŸï¼Œå¼€å§‹åŠ è½½å†…åµŒèµ„æºçš„æ—¶é—´æˆ³ï¼Œdocument.readyState çš„çŠ¶æ€ä¸º interactiveã€‚
    domContentLoadedEventStart, // DOMContentLoaded äº‹ä»¶è§¦å‘æ—¶çš„æ—¶é—´æˆ³ï¼Œæ‰€æœ‰éœ€è¦æ‰§è¡Œçš„è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚
    domContentLoadedEventEnd,  // DOMContentLoaded äº‹ä»¶ç»“æŸæ—¶çš„æ—¶é—´æˆ³
    domComplete, // dom æ–‡æ¡£å®Œæˆè§£æçš„æ—¶é—´æˆ³ï¼Œ document.readyState çš„å€¼ä¸º completeã€‚
    loadEventStart, // load äº‹ä»¶è§¦å‘çš„æ—¶é—´ã€‚
    loadEventEnd // load æ—¶é—´ç»“æŸæ—¶çš„æ—¶é—´ã€‚
}
```

åæ¥ window.performance.timing è¢«åºŸå¼ƒï¼Œé€šè¿‡ [PerformanceObserver](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FPerformanceObserver 'https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver') æ¥è·å–ã€‚æ—§çš„ apiï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª `UNIX` ç±»å‹çš„ç»å¯¹æ—¶é—´ï¼Œå’Œç”¨æˆ·çš„ç³»ç»Ÿæ—¶é—´ç›¸å…³ï¼Œåˆ†æçš„æ—¶å€™éœ€è¦å†æ¬¡è®¡ç®—ã€‚è€Œæ–°çš„ apiï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼Œå¯ä»¥ç›´æ¥ç”¨æ¥åˆ†æ

ç°åœ¨ chrome å¼€å‘å›¢é˜Ÿæä¾›äº† [web-vitals](https://www.npmjs.com/package/web-vitals) åº“ï¼Œæ–¹ä¾¿æ¥è®¡ç®—å„æ€§èƒ½æ•°æ®ï¼ˆæ³¨æ„ï¼šweb-vitals ä¸æ”¯æŒ safari æµè§ˆå™¨ï¼‰

å…³äº FPã€FCPã€LCPã€CLSã€TTFBã€FID ç­‰æ€§èƒ½æŒ‡æ ‡çš„å«ä¹‰å’Œè®¡ç®—æ–¹å¼ï¼Œæˆ‘åœ¨
[ã€Œå†æ—¶ 8 ä¸ªæœˆã€10 ä¸‡å­—å‰ç«¯çŸ¥è¯†ä½“ç³»æ€»ç»“ï¼ˆå·¥ç¨‹åŒ–ç¯‡ï¼‰ğŸ”¥](https://juejin.cn/post/7146976516692410376/#heading-63) ä¸­æœ‰è¯¦ç»†çš„è®²è§£ï¼Œè¿™é‡Œä¸å†èµ˜è¿°

## ç”¨æˆ·è¡Œä¸ºæ•°æ®é‡‡é›†

ç”¨æˆ·è¡Œä¸ºåŒ…æ‹¬ï¼šé¡µé¢è·¯ç”±å˜åŒ–ã€é¼ æ ‡ç‚¹å‡»ã€èµ„æºåŠ è½½ã€æ¥å£è°ƒç”¨ã€ä»£ç æŠ¥é”™ç­‰è¡Œä¸º

### è®¾è®¡æ€è·¯

1ã€é€šè¿‡ Breadcrumb ç±»æ¥åˆ›å»ºç”¨æˆ·è¡Œä¸ºçš„å¯¹è±¡ï¼Œæ¥å­˜å‚¨å’Œç®¡ç†æ‰€æœ‰çš„ç”¨æˆ·è¡Œä¸º

2ã€é€šè¿‡é‡å†™æˆ–æ·»åŠ ç›¸åº”çš„äº‹ä»¶ï¼Œå®Œæˆç”¨æˆ·è¡Œä¸ºæ•°æ®çš„é‡‡é›†

ç”¨æˆ·è¡Œä¸ºä»£ç ç¤ºä¾‹ï¼š

```
// åˆ›å»ºç”¨æˆ·è¡Œä¸ºç±»
class Breadcrumb {
  // maxBreadcrumbsæ§åˆ¶ä¸ŠæŠ¥ç”¨æˆ·è¡Œä¸ºçš„æœ€å¤§æ¡æ•°
  maxBreadcrumbs = 20;
  // stack å­˜å‚¨ç”¨æˆ·è¡Œä¸º
  stack = [];
  constructor() {}
  // æ·»åŠ ç”¨æˆ·è¡Œä¸ºæ ˆ
  push(data) {
    if (this.stack.length >= this.maxBreadcrumbs) {
      // è¶…å‡ºåˆ™åˆ é™¤ç¬¬ä¸€æ¡
      this.stack.shift();
    }
    this.stack.push(data);
    // æŒ‰ç…§æ—¶é—´æ’åº
    this.stack.sort((a, b) => a.time - b.time);
  }
}

let breadcrumb = new Breadcrumb();

// æ·»åŠ ä¸€æ¡é¡µé¢è·³è½¬çš„è¡Œä¸ºï¼Œä»homeé¡µé¢è·³è½¬åˆ°abouté¡µé¢
breadcrumb.push({
  type: "Route",
  form: '/home',
  to: '/about'
  url: "http://localhost:3000/index.html",
  time: "1668759320435"
});

// æ·»åŠ ä¸€æ¡ç”¨æˆ·ç‚¹å‡»è¡Œä¸º
breadcrumb.push({
  type: "Click",
  dom: "<button id='btn'>æŒ‰é’®</button>",
  time: "1668759620485"
});

// æ·»åŠ ä¸€æ¡è°ƒç”¨æ¥å£è¡Œä¸º
breadcrumb.push({
  type: "Xhr",
  url: "http://10.105.10.12/monitor/open/pushData",
  time: "1668760485550"
});

// ä¸ŠæŠ¥ç”¨æˆ·è¡Œä¸º
reportData({
  uuid: "a6481683-6d2e-4bd8-bba1-64819d8cce8c",
  stack: breadcrumb.getStack()
});
```

### é¡µé¢è·³è½¬

é€šè¿‡ç›‘å¬è·¯ç”±çš„å˜åŒ–æ¥åˆ¤æ–­é¡µé¢è·³è½¬ï¼Œè·¯ç”±æœ‰`historyã€hash`ä¸¤ç§æ¨¡å¼ï¼Œhistory æ¨¡å¼å¯ä»¥ç›‘å¬`popstate`äº‹ä»¶ï¼Œhash æ¨¡å¼é€šè¿‡é‡å†™ `pushStateå’Œ replaceState`äº‹ä»¶

vue é¡¹ç›®ä¸­ä¸èƒ½é€šè¿‡ `hashchange` äº‹ä»¶æ¥ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œ`vue-router` åº•å±‚è°ƒç”¨çš„æ˜¯ `history.pushState` å’Œ `history.replaceState`ï¼Œä¸ä¼šè§¦å‘ hashchange

vue-router æºç ï¼š

```
function pushState (url, replace) {
  saveScrollPosition();
  var history = window.history;
  try {
    if (replace) {
      history.replaceState({ key: _key }, '', url);
    } else {
      _key = genKey();
      history.pushState({ key: _key }, '', url);
    }
  } catch (e) {
    window.location[replace ? 'replace' : 'assign'](url);
  }
}
...

// this.$router.pushæ—¶è§¦å‘
function pushHash (path) {
  if (supportsPushState) {
    pushState(getUrl(path));
  } else {
    window.location.hash = path;
  }
}
```

é€šè¿‡é‡å†™ pushStateã€replaceState äº‹ä»¶æ¥ç›‘å¬è·¯ç”±å˜åŒ–

```
// lastHref å‰ä¸€ä¸ªé¡µé¢çš„è·¯ç”±
let lastHref = document.location.href;
function historyReplace() {
  function historyReplaceFn(originalHistoryFn) {
    return function(...args) {
      const url = args.length > 2 ? args[2] : undefined;
      if (url) {
        const from = lastHref;
        const to = String(url);
        lastHref = to;
        // ä¸ŠæŠ¥è·¯ç”±å˜åŒ–
        reportData("routeChange", {
          from,
          to
        });
      }
      return originalHistoryFn.apply(this, args);
    };
  }
  // é‡å†™pushStateäº‹ä»¶
  replaceAop(window.history, "pushState", historyReplaceFn);
  // é‡å†™replaceStateäº‹ä»¶
  replaceAop(window.history, "replaceState", historyReplaceFn);
}

function replaceAop(source, name, fn) {
  if (source === undefined) return;
  if (name in source) {
    var original = source[name];
    var wrapped = fn(original);
    if (typeof wrapped === "function") {
      source[name] = wrapped;
    }
  }
}
```

### ç”¨æˆ·ç‚¹å‡»

ç»™ document å¯¹è±¡æ·»åŠ  click äº‹ä»¶ï¼Œå¹¶ä¸ŠæŠ¥

```
function domReplace() {
  document.addEventListener("click",({ target }) => {
      const tagName = target.tagName.toLowerCase();
      if (tagName === "body") {
        return null;
      }
      let classNames = target.classList.value;
      classNames = classNames !== "" ? ` class="${classNames}"` : "";
      const id = target.id ? ` id="${target.id}"` : "";
      const innerText = target.innerText;
      // è·å–åŒ…å«idã€classã€innerTextdeå­—ç¬¦ä¸²çš„æ ‡ç­¾
      let dom = `<${tagName}${id}${
        classNames !== "" ? classNames : ""
      }>${innerText}</${tagName}>`;
      // ä¸ŠæŠ¥
      reportData({
        type: 'Click',
        dom
      });
    },
    true
  );
}
```

### èµ„æºåŠ è½½

è·å–é¡µé¢ä¸­åŠ è½½çš„èµ„æºä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒä»¬çš„ url æ˜¯ä»€ä¹ˆã€åŠ è½½äº†å¤šä¹…ã€æ˜¯å¦æ¥è‡ªç¼“å­˜ç­‰ï¼Œæœ€ç»ˆç”Ÿæˆ [èµ„æºåŠ è½½ç€‘å¸ƒå›¾](https://blog.csdn.net/csdn_girl/article/details/54911632)

![waterfall .png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e92b04772b2044e5a2cc21b1b73c9acb~tplv-k3u1fbpfcp-watermark.image?)

ç€‘å¸ƒå›¾å±•ç°äº†æµè§ˆå™¨ä¸ºæ¸²æŸ“ç½‘é¡µè€ŒåŠ è½½çš„æ‰€æœ‰çš„èµ„æºï¼ŒåŒ…æ‹¬åŠ è½½çš„é¡ºåºå’Œæ¯ä¸ªèµ„æºçš„åŠ è½½æ—¶é—´

åˆ†æè¿™äº›èµ„æºæ˜¯å¦‚ä½•åŠ è½½çš„, å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ç©¶ç«Ÿæ˜¯ä»€ä¹ˆåŸå› æ‹–æ…¢äº†ç½‘é¡µï¼Œä»è€Œé‡‡å–å¯¹åº”çš„æªæ–½æ¥æå‡ç½‘é¡µé€Ÿåº¦

å¯ä»¥é€šè¿‡ Â [performance.getEntriesByType('resource')](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/getEntriesByType) è·å–é¡µé¢åŠ è½½çš„èµ„æºåˆ—è¡¨ï¼ŒåŒæ—¶å¯ä»¥ç»“åˆ Â initiatorType å­—æ®µæ¥åˆ¤æ–­èµ„æºç±»å‹ï¼Œå¯¹èµ„æºè¿›è¡Œè¿‡æ»¤

å…¶ä¸­ [PerformanceResourceTiming](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/getEntriesByType) æ¥åˆ†æèµ„æºåŠ è½½çš„è¯¦ç»†æ•°æ®

```
// PerformanceResourceTiming å„å­—æ®µè¯´æ˜
{
  connectEnd, // è¡¨ç¤ºæµè§ˆå™¨å®Œæˆå»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ä»¥æ£€ç´¢èµ„æºä¹‹åçš„æ—¶é—´
  connectStart, // è¡¨ç¤ºæµè§ˆå™¨å¼€å§‹å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ä»¥æ£€ç´¢èµ„æºä¹‹å‰çš„æ—¶é—´
  decodedBodySize, // è¡¨ç¤ºåœ¨åˆ é™¤ä»»ä½•åº”ç”¨çš„å†…å®¹ç¼–ç ä¹‹åï¼Œä»*æ¶ˆæ¯ä¸»ä½“*çš„è¯·æ±‚ï¼ˆHTTP æˆ–ç¼“å­˜ï¼‰ä¸­æ¥æ”¶åˆ°çš„å¤§å°ï¼ˆä»¥å…«ä½å­—èŠ‚ä¸ºå•ä½ï¼‰
  domainLookupEnd, // è¡¨ç¤ºæµè§ˆå™¨å®Œæˆèµ„æºçš„åŸŸåæŸ¥æ‰¾ä¹‹åçš„æ—¶é—´
  domainLookupStart, // è¡¨ç¤ºåœ¨æµè§ˆå™¨ç«‹å³å¼€å§‹èµ„æºçš„åŸŸåæŸ¥æ‰¾ä¹‹å‰çš„æ—¶é—´
  duration, // è¿”å›ä¸€ä¸ªtimestampï¼Œå³Â responseEnd å’Œ startTime å±æ€§çš„å·®å€¼
  encodedBodySize, // è¡¨ç¤ºåœ¨åˆ é™¤ä»»ä½•åº”ç”¨çš„å†…å®¹ç¼–ç ä¹‹å‰ï¼Œä»*æœ‰æ•ˆå†…å®¹ä¸»ä½“*çš„è¯·æ±‚ï¼ˆHTTP æˆ–ç¼“å­˜ï¼‰ä¸­æ¥æ”¶åˆ°çš„å¤§å°ï¼ˆä»¥å…«ä½å­—èŠ‚ä¸ºå•ä½ï¼‰
  entryType, // è¿”å›Â "resource"
  fetchStart, // è¡¨ç¤ºæµè§ˆå™¨å³å°†å¼€å§‹è·å–èµ„æºä¹‹å‰çš„æ—¶é—´
  initiatorType, // ä»£è¡¨å¯åŠ¨æ€§èƒ½æ¡ç›®çš„èµ„æºçš„ç±»å‹ï¼Œå¦‚Â PerformanceResourceTiming.initiatorTypeÂ ä¸­æ‰€æŒ‡å®š
  name, // è¿”å›èµ„æº URL
  nextHopProtocol, // ä»£è¡¨ç”¨äºè·å–èµ„æºçš„ç½‘ç»œåè®®
  redirectEnd, // è¡¨ç¤ºæ”¶åˆ°ä¸Šä¸€æ¬¡é‡å®šå‘å“åº”çš„å‘é€æœ€åä¸€ä¸ªå­—èŠ‚æ—¶çš„æ—¶é—´
  redirectStart, // è¡¨ç¤ºä¸Šä¸€æ¬¡é‡å®šå‘å¼€å§‹çš„æ—¶é—´
  requestStart, // è¡¨ç¤ºæµè§ˆå™¨å¼€å§‹å‘æœåŠ¡å™¨è¯·æ±‚èµ„æºä¹‹å‰çš„æ—¶é—´
  responseEnd, // è¡¨ç¤ºåœ¨æµè§ˆå™¨æ¥æ”¶åˆ°èµ„æºçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¹‹åæˆ–åœ¨ä¼ è¾“è¿æ¥å…³é—­ä¹‹å‰ï¼ˆä»¥å…ˆåˆ°è€…ä¸ºå‡†ï¼‰çš„æ—¶é—´
  responseStart, // è¡¨ç¤ºæµè§ˆå™¨ä»æœåŠ¡å™¨æ¥æ”¶åˆ°å“åº”çš„ç¬¬ä¸€ä¸ªå­—èŠ‚åçš„æ—¶é—´
  secureConnectionStart, // è¡¨ç¤ºæµè§ˆå™¨å³å°†å¼€å§‹æ¡æ‰‹è¿‡ç¨‹ä»¥ä¿æŠ¤å½“å‰è¿æ¥ä¹‹å‰çš„æ—¶é—´
  serverTiming, // ä¸€ä¸ªÂ PerformanceServerTimingÂ æ•°ç»„ï¼ŒåŒ…å«æœåŠ¡å™¨è®¡æ—¶æŒ‡æ ‡çš„PerformanceServerTimingÂ æ¡ç›®
  startTime, // è¡¨ç¤ºèµ„æºè·å–å¼€å§‹çš„æ—¶é—´ã€‚è¯¥å€¼ç­‰æ•ˆäºÂ PerformanceEntry.fetchStart
  transferSize, // ä»£è¡¨æ‰€è·å–èµ„æºçš„å¤§å°ï¼ˆä»¥å…«ä½å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚è¯¥å¤§å°åŒ…æ‹¬å“åº”æ ‡å¤´å­—æ®µä»¥åŠå“åº”æœ‰æ•ˆå†…å®¹ä¸»ä½“
  workerStart // å¦‚æœæœåŠ¡ Worker çº¿ç¨‹å·²ç»åœ¨è¿è¡Œï¼Œåˆ™è¿”å›åœ¨åˆ†æ´¾Â FetchEvent ä¹‹å‰çš„æ—¶é—´æˆ³ï¼Œå¦‚æœå°šæœªè¿è¡Œï¼Œåˆ™è¿”å›åœ¨å¯åŠ¨ Service Worker çº¿ç¨‹ä¹‹å‰çš„æ—¶é—´æˆ³ã€‚å¦‚æœæœåŠ¡ Worker æœªæ‹¦æˆªè¯¥èµ„æºï¼Œåˆ™è¯¥å±æ€§å°†å§‹ç»ˆè¿”å› 0ã€‚
}
```

è·å–èµ„æºåŠ è½½æ—¶é•¿ä¸º `duration` å­—æ®µï¼Œå³ Â `responseEnd ä¸ startTime` çš„å·®å€¼

è·å–åŠ è½½èµ„æºåˆ—è¡¨ï¼š

```
function getResource() {
  if (performance.getEntriesByType) {
    const entries = performance.getEntriesByType('resource');
    // è¿‡æ»¤æ‰éé™æ€èµ„æºçš„ fetchã€ xmlhttprequestã€beacon
    let list = entries.filter((entry) => {
      return ['fetch', 'xmlhttprequest', 'beacon'].indexOf(entry.initiatorType) === -1;
    });

    if (list.length) {
      list = JSON.parse(JSON.stringify(list));
      list.forEach((entry) => {
        entry.isCache = isCache(entry);
      });
    }
    return list;
  }
}

// åˆ¤æ–­èµ„æ–™æ˜¯å¦æ¥è‡ªç¼“å­˜
// transferSizeä¸º0ï¼Œè¯´æ˜æ˜¯ä»ç¼“å­˜ä¸­ç›´æ¥è¯»å–çš„ï¼ˆå¼ºåˆ¶ç¼“å­˜ï¼‰
// transferSizeä¸ä¸º0ï¼Œä½†æ˜¯`encodedBodySize` å­—æ®µä¸º 0ï¼Œè¯´æ˜å®ƒèµ°çš„æ˜¯åå•†ç¼“å­˜ï¼ˆ`encodedBodySize è¡¨ç¤ºè¯·æ±‚å“åº”æ•°æ® body çš„å¤§å°`ï¼‰
function isCache(entry) {
  return entry.transferSize === 0 || (entry.transferSize !== 0 && entry.encodedBodySize === 0);
}
```

ä¸€ä¸ªçœŸå®çš„é¡µé¢ä¸­ï¼Œèµ„æºåŠ è½½å¤§å¤šæ•°æ˜¯é€æ­¥è¿›è¡Œçš„ï¼Œæœ‰äº›èµ„æºæœ¬èº«å°±åšäº†å»¶è¿ŸåŠ è½½ï¼Œæœ‰äº›æ˜¯éœ€è¦ç”¨æˆ·å‘ç”Ÿäº¤äº’åæ‰ä¼šå»è¯·æ±‚ä¸€äº›èµ„æº

å¦‚æœæˆ‘ä»¬åªå…³æ³¨é¦–é¡µèµ„æºï¼Œå¯ä»¥åœ¨ `window.onload` äº‹ä»¶ä¸­å»æ”¶é›†

å¦‚æœè¦æ”¶é›†æ‰€æœ‰çš„èµ„æºï¼Œéœ€è¦é€šè¿‡å®šæ—¶å™¨åå¤åœ°å»æ”¶é›†ï¼Œå¹¶ä¸”åœ¨ä¸€è½®æ”¶é›†ç»“æŸåï¼Œé€šè¿‡è°ƒç”¨ Â [clearResourceTimings](https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearResourceTimings)Â  å°† performance entries é‡Œçš„ä¿¡æ¯æ¸…ç©ºï¼Œé¿å…åœ¨ä¸‹ä¸€è½®æ”¶é›†æ—¶å–åˆ°é‡å¤çš„èµ„æº

## ä¸ªæ€§åŒ–æŒ‡æ ‡

### long task

æ‰§è¡Œæ—¶é—´è¶…è¿‡ 50ms çš„ä»»åŠ¡ï¼Œè¢«ç§°ä¸º [long task ](https://developer.mozilla.org/zh-CN/docs/Web/API/Long_Tasks_API) é•¿ä»»åŠ¡

è·å–é¡µé¢çš„é•¿ä»»åŠ¡åˆ—è¡¨ï¼š

```
const entryHandler = list => {
  for (const long of list.getEntries()) {
    // è·å–é•¿ä»»åŠ¡è¯¦æƒ…
    console.log(long);
  }
};

let observer = new PerformanceObserver(entryHandler);
observer.observe({ entryTypes: ["longtask"] });
```

### memory é¡µé¢å†…å­˜

`performance.memory` å¯ä»¥æ˜¾ç¤ºæ­¤åˆ»å†…å­˜å ç”¨æƒ…å†µï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€å€¼ï¼Œå…¶ä¸­ï¼š

- jsHeapSizeLimit è¯¥å±æ€§ä»£è¡¨çš„å«ä¹‰æ˜¯ï¼šå†…å­˜å¤§å°çš„é™åˆ¶ã€‚

- totalJSHeapSize è¡¨ç¤ºæ€»å†…å­˜çš„å¤§å°ã€‚

- usedJSHeapSize è¡¨ç¤ºå¯ä½¿ç”¨çš„å†…å­˜çš„å¤§å°ã€‚

é€šå¸¸ï¼ŒusedJSHeapSize ä¸èƒ½å¤§äº totalJSHeapSizeï¼Œå¦‚æœå¤§äºï¼Œæœ‰å¯èƒ½å‡ºç°äº†å†…å­˜æ³„æ¼

```
// loadäº‹ä»¶ä¸­è·å–æ­¤æ—¶é¡µé¢çš„å†…å­˜å¤§å°
window.addEventListener("load", () => {
  console.log("memory", performance.memory);
});
```

### é¦–å±åŠ è½½æ—¶é—´

é¦–å±åŠ è½½æ—¶é—´å’Œé¦–é¡µåŠ è½½æ—¶é—´ä¸ä¸€æ ·ï¼Œé¦–å±æŒ‡çš„æ˜¯å±å¹•å†…çš„ dom æ¸²æŸ“å®Œæˆçš„æ—¶é—´

æ¯”å¦‚é¦–é¡µå¾ˆé•¿éœ€è¦å¥½å‡ å±å±•ç¤ºï¼Œè¿™ç§æƒ…å†µä¸‹å±å¹•ä»¥å¤–çš„å…ƒç´ ä¸è€ƒè™‘åœ¨å†…

**è®¡ç®—é¦–å±åŠ è½½æ—¶é—´æµç¨‹**

1ï¼‰åˆ©ç”¨`MutationObserver`ç›‘å¬`document`å¯¹è±¡ï¼Œæ¯å½“ dom å˜åŒ–æ—¶è§¦å‘è¯¥äº‹ä»¶

2ï¼‰åˆ¤æ–­ç›‘å¬çš„ dom æ˜¯å¦åœ¨é¦–å±å†…ï¼Œå¦‚æœåœ¨é¦–å±å†…ï¼Œå°†è¯¥ dom æ”¾åˆ°æŒ‡å®šçš„æ•°ç»„ä¸­ï¼Œè®°å½•ä¸‹å½“å‰ dom å˜åŒ–çš„æ—¶é—´ç‚¹

3ï¼‰åœ¨ MutationObserver çš„ callback å‡½æ•°ä¸­ï¼Œé€šè¿‡é˜²æŠ–å‡½æ•°ï¼Œç›‘å¬`document.readyState`çŠ¶æ€çš„å˜åŒ–

4ï¼‰å½“`document.readyState === 'complete'`ï¼Œåœæ­¢å®šæ—¶å™¨å’Œ å–æ¶ˆå¯¹ document çš„ç›‘å¬

5ï¼‰éå†å­˜æ”¾ dom çš„æ•°ç»„ï¼Œæ‰¾å‡ºæœ€åå˜åŒ–èŠ‚ç‚¹çš„æ—¶é—´ï¼Œç”¨è¯¥æ—¶é—´ç‚¹å‡å»`performance.timing.navigationStart` å¾—å‡ºé¦–å±çš„åŠ è½½æ—¶é—´

## ç›‘æ§ SDK

ç›‘æ§ SDK çš„ä½œç”¨ï¼šæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥

### æ•´ä½“æ¶æ„

![sdkProcess.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca8db3058b2d49608a447dbc4dccbc0c~tplv-k3u1fbpfcp-watermark.image?)

æ•´ä½“æ¶æ„ä½¿ç”¨ **å‘å¸ƒ-è®¢é˜…** è®¾è®¡æ¨¡å¼ï¼Œè¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ä¾¿äºåç»­æ‰©å±•ä¸ç»´æŠ¤ï¼Œå¦‚æœæƒ³æ·»åŠ æ–°çš„`hook`æˆ–äº‹ä»¶ï¼Œåœ¨è¯¥å›è°ƒä¸­æ·»åŠ å¯¹åº”çš„å‡½æ•°å³å¯

### SDK å…¥å£

`src/index.js`

å¯¹å¤–å¯¼å‡º init äº‹ä»¶ï¼Œé…ç½®äº† vueã€react é¡¹ç›®çš„ä¸åŒå¼•å…¥æ–¹å¼

vue é¡¹ç›®åœ¨ Vue.config.errorHandler ä¸­ä¸ŠæŠ¥é”™è¯¯ï¼Œreact é¡¹ç›®åœ¨ ErrorBoundary ä¸­ä¸ŠæŠ¥é”™è¯¯

![entry.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0124fc1be85f43f8b6172f6bdb950218~tplv-k3u1fbpfcp-watermark.image?)

### äº‹ä»¶å‘å¸ƒä¸è®¢é˜…

é€šè¿‡æ·»åŠ ç›‘å¬äº‹ä»¶æ¥æ•è·é”™è¯¯ï¼Œåˆ©ç”¨ AOP åˆ‡ç‰‡ç¼–ç¨‹ï¼Œé‡å†™æ¥å£è¯·æ±‚ã€è·¯ç”±ç›‘å¬ç­‰åŠŸèƒ½ï¼Œä»è€Œè·å–å¯¹åº”çš„æ•°æ®

`src/load.js`

![replace.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/498c219e4d01449cac3be2c9a3f9db24~tplv-k3u1fbpfcp-watermark.image?)

### ç”¨æˆ·è¡Œä¸ºæ”¶é›†

`core/breadcrumb.js`

åˆ›å»ºç”¨æˆ·è¡Œä¸ºç±»ï¼Œstack ç”¨æ¥å­˜å‚¨ç”¨æˆ·è¡Œä¸ºï¼Œå½“é•¿åº¦è¶…è¿‡é™åˆ¶æ—¶ï¼Œæœ€æ—©çš„ä¸€æ¡æ•°æ®ä¼šè¢«è¦†ç›–æ‰ï¼Œåœ¨ä¸ŠæŠ¥é”™è¯¯æ—¶ï¼Œå¯¹åº”çš„ç”¨æˆ·è¡Œä¸ºä¼šæ·»åŠ åˆ°è¯¥é”™è¯¯ä¿¡æ¯ä¸­

![bread.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e5fcce29ac54bb1a2cede02b395bfbb~tplv-k3u1fbpfcp-watermark.image?)

### æ•°æ®ä¸ŠæŠ¥æ–¹å¼

æ”¯æŒå›¾ç‰‡æ‰“ç‚¹ä¸ŠæŠ¥å’Œ fetch è¯·æ±‚ä¸ŠæŠ¥ä¸¤ç§æ–¹å¼

å›¾ç‰‡æ‰“ç‚¹ä¸ŠæŠ¥çš„ä¼˜åŠ¿ï¼š  
1ï¼‰æ”¯æŒè·¨åŸŸï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¸ŠæŠ¥åŸŸåéƒ½ä¸æ˜¯å½“å‰åŸŸåï¼Œä¸ŠæŠ¥çš„æ¥å£è¯·æ±‚ä¼šæ„æˆè·¨åŸŸ  
2ï¼‰ä½“ç§¯å°ä¸”ä¸éœ€è¦æ’å…¥ dom ä¸­  
3ï¼‰ä¸éœ€è¦ç­‰å¾…æœåŠ¡å™¨è¿”å›æ•°æ®

å›¾ç‰‡æ‰“ç‚¹ç¼ºç‚¹æ˜¯ï¼šurl å—æµè§ˆå™¨é•¿åº¦é™åˆ¶

`core/transportData.js`

![send.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a5c83e0ee5f41428e5bca3de2f7dd2c~tplv-k3u1fbpfcp-watermark.image?)

### æ•°æ®ä¸ŠæŠ¥æ—¶æœº

ä¼˜å…ˆä½¿ç”¨ requestIdleCallbackï¼Œåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´ä¸ŠæŠ¥ï¼Œå…¶æ¬¡ä½¿ç”¨å¾®ä»»åŠ¡ä¸ŠæŠ¥

![queue.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/293f0ce61c994a16aaf2ed2341803878~tplv-k3u1fbpfcp-watermark.image?)

ç›‘æ§ SDKï¼Œå‚è€ƒäº† [sentry](https://github.com/getsentry/sentry-javascript)ã€ [monitor](https://github.com/clouDr-f2e/monitor)ã€ [mitojs](https://github.com/mitojs/mitojs)

## é¡¹ç›®åå° demo

ä¸»è¦ç”¨æ¥æ¼”ç¤ºé”™è¯¯è¿˜åŸåŠŸèƒ½ï¼Œæ–¹å¼åŒ…æ‹¬ï¼šå®šä½æºç ã€æ’­æ”¾å½•å±ã€è®°å½•ç”¨æˆ·è¡Œä¸º

## [](https://github.com/xy-sea/web-see-demo#%E5%8A%9F%E8%83%BD)

![web-see.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/179f1b31741443eab79be2a59eb62f28~tplv-k3u1fbpfcp-watermark.image?)

åå° demo åŠŸèƒ½ä»‹ç»ï¼š

1ã€ä½¿ç”¨ express å¼€å¯é™æ€æœåŠ¡å™¨ï¼Œæ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒï¼Œç”¨äºå®ç°å®šä½æºç çš„åŠŸèƒ½

2ã€server.js ä¸­å®ç°äº† reportDataï¼ˆé”™è¯¯ä¸ŠæŠ¥ï¼‰ã€getmapï¼ˆè·å– map æ–‡ä»¶ï¼‰ã€getRecordScreenIdï¼ˆè·å–å½•å±ä¿¡æ¯ï¼‰ã€ getErrorListï¼ˆè·å–é”™è¯¯åˆ—è¡¨ï¼‰çš„æ¥å£

3ã€ç”¨æˆ·å¯ç‚¹å‡» 'js æŠ¥é”™'ã€'å¼‚æ­¥æŠ¥é”™'ã€'promise é”™è¯¯' æŒ‰é’®ï¼Œä¸ŠæŠ¥å¯¹åº”çš„ä»£ç é”™è¯¯ï¼Œåå°å®ç°é”™è¯¯è¿˜åŸåŠŸèƒ½

4ã€ç‚¹å‡» 'xhr è¯·æ±‚æŠ¥é”™'ã€'fetch è¯·æ±‚æŠ¥é”™' æŒ‰é’®ï¼Œä¸ŠæŠ¥æ¥å£æŠ¥é”™ä¿¡æ¯

5ã€ç‚¹å‡» 'åŠ è½½èµ„æºæŠ¥é”™' æŒ‰é’®ï¼Œä¸ŠæŠ¥å¯¹åº”çš„èµ„æºæŠ¥é”™ä¿¡æ¯

é€šè¿‡è¿™äº›å¼‚æ­¥çš„æ•è·ï¼Œäº†è§£ç›‘æ§å¹³å°çš„æ•´ä½“æµç¨‹

## å®‰è£…ä¸ä½¿ç”¨

npm å®˜ç½‘æœç´¢ [web-see](https://www.npmjs.com/package/web-see)

<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2577f7151904489283ffa5fd6fb0213a~tplv-k3u1fbpfcp-watermark.image?" alt="install.jpg" width="90%" />

## ä»“åº“åœ°å€

ç›‘æ§ SDKï¼š [web-see](https://github.com/xy-sea/web-see)

ç›‘æ§åå°ï¼š [web-see-demo](https://github.com/xy-sea/web-see-demo)

## æ€»ç»“

ç›®å‰å¸‚é¢ä¸Šçš„å‰ç«¯ç›‘æ§æ–¹æ¡ˆå¯è°“æ˜¯ç™¾èŠ±é½æ”¾ï¼Œä½†åº•å±‚åŸç†éƒ½æ˜¯ç›¸é€šçš„ã€‚ä»åŸºç¡€çš„ç†è®ºçŸ¥è¯†åˆ°å®ç°ä¸€ä¸ªå¯ç”¨çš„ç›‘æ§å¹³å°ï¼Œæ”¶è·è¿˜æ˜¯æŒºå¤šçš„

æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ç»“åˆ git ä»“åº“çš„æºç ç©ä¸€ç©ï¼Œå†ç»“åˆæœ¬æ–‡ä¸€èµ·é˜…è¯»ï¼Œå¸®åŠ©åŠ æ·±ç†è§£

## åç»­

ä¸‹ä¸€ç¯‡ä¼šç»§ç»­è®¨è®ºå‰ç«¯ç›‘æ§ï¼Œè®²è§£å…·ä½“å¦‚ä½•å®ç°ï¼šå®šä½æºç ã€æ’­æ”¾å½•å±ç­‰åŠŸèƒ½

**æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ç‚¹ä¸ªå…³æ³¨ï¼Œåç»­å¥½æ–‡ä¸æ–­ï¼**
