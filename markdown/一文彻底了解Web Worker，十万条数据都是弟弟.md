**å¦‚ä½•è®©å‰ç«¯æ‹¥æœ‰åç«¯çš„è®¡ç®—èƒ½åŠ›ï¼Œåœ¨ç®—åŠ›ç´§ç¼ºçš„å¹´ä»£ï¼Œæ‰©å±•å‰ç«¯çš„ä¸šåŠ¡è¾¹ç•Œï¼**

## å‰è¨€

é¡µé¢ä¸­æœ‰åä¸‡æ¡æ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œå¤æ‚è¿ç®—ï¼Œéœ€è¦å¤šä¹…å‘¢ï¼Ÿ

è¡¨æ ¼ 4000 è¡Œï¼Œ25 åˆ—ï¼Œå…±åä¸‡æ¡æ•°æ®

**è¿ç®—åŒ…æ‹¬**ï¼šæ€»å’Œã€ç®—æœ¯å¹³å‡ã€åŠ æƒå¹³å‡ã€æœ€å¤§ã€æœ€å°ã€è®¡æ•°ã€æ ·æœ¬æ ‡å‡†å·®ã€æ ·æœ¬æ–¹å·®ã€ä¸­ä½æ•°ã€æ€»ä½“æ ‡å‡†å·®ã€æ€»ä½“æ–¹å·®

![table.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9244b9f93e7546059844ba41176339eb~tplv-k3u1fbpfcp-watermark.image?)

ç­”æ¡ˆæ˜¯: **35s å·¦å³**

_æ³¨ï¼šå…·ä½“æ—¶é—´æ ¹æ®ç”µè„‘é…ç½®ä¼šæœ‰æ‰€ä¸åŒ_

**å¹¶ä¸”** è¿™ä¸ªæ—¶é—´æ®µå†…ï¼Œé¡µé¢ä¸€ç›´å¤„äºå‡æ­»çŠ¶æ€ï¼Œå¯¹é¡µé¢åšä»»ä½•æ“ä½œéƒ½æ²¡æœ‰ååº” ğŸ˜­ğŸ˜­ğŸ˜­

<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2df71b2125a44c3b1160bc9daf3476d~tplv-k3u1fbpfcp-watermark.image?" alt="boom.gif" width="20%" />

**ä»€ä¹ˆæ˜¯å‡æ­»ï¼Ÿ**

æµè§ˆå™¨æœ‰ GUI æ¸²æŸ“çº¿ç¨‹ä¸ JS å¼•æ“çº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹æ˜¯äº’æ–¥çš„å…³ç³»

å½“ js æœ‰å¤§é‡è®¡ç®—æ—¶ï¼Œä¼šé€ æˆ UI é˜»å¡ï¼Œå‡ºç°ç•Œé¢å¡é¡¿ã€æ‰å¸§ç­‰æƒ…å†µï¼Œä¸¥é‡æ—¶ä¼šå‡ºç°é¡µé¢å¡æ­»çš„æƒ…å†µï¼Œä¿—ç§°**å‡æ­»**

## è‡´å‘½ bug

**å¼ºè¡Œé€æµ‹å§**

æµ‹è¯•å°å§å§ï¼šä½ çš„é¡µé¢åˆæ­»äº†ï¼ï¼  
æˆ‘ï¼šè¿˜æ²¡æœ‰æ­»ï¼Œåœ¨ ICUâ€¦â€¦ ï¼Œè¿‡ä¸€ä¼šå°±å¥½äº†  
æµ‹è¯•å°å§å§ï¼šå·²ç»ç­‰äº†å¥½ä¸€ä¼šäº†ï¼Œè¿˜ä¸è¡Œå•Šï¼Œæ˜¯ä¸ª**è‡´å‘½ bug**ğŸ’¥  
æˆ‘ï¼šâ€¦â€¦

<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4006164b249041f8915173749370f343~tplv-k3u1fbpfcp-watermark.image?" alt="ç»æœ›.jpg" width="25%" />

**é—¯è¡å‰ç«¯æ•°åè½½ï¼Œç«Ÿè¢«æäº†ä¸ªè‡´å‘½ bugï¼Œé¢œé¢ä½•åœ¨ï¼ğŸ™ˆ**

## Performance åˆ†æå‡æ­»æœŸé—´çš„æ€§èƒ½è¡¨ç°

**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ­¤æ¬¡è®¡ç®—æ€»ç”¨æ—¶ä¸º 35.45s**

é‡ç‚¹ä»ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢åˆ†æï¼š

**1ï¼‰FPS**

FPS: è¡¨ç¤ºæ¯ç§’ä¼ è¾“å¸§æ•°ï¼Œæ˜¯åˆ†æåŠ¨ç”»çš„ä¸€ä¸ªä¸»è¦æ€§èƒ½æŒ‡æ ‡ï¼Œç»¿è‰²çš„é•¿åº¦è¶Šé•¿ï¼Œç”¨æˆ·ä½“éªŒè¶Šå¥½ï¼›åä¹‹çº¢è‰²è¶Šé•¿ï¼Œè¯´æ˜å¡é¡¿ä¸¥é‡

**ä»å›¾ä¸­çœ‹åˆ° FPS ä¸­æœ‰ä¸€æ¡æŒç»­äº† 35s çš„çº¢çº¿ï¼Œè¯´æ˜è¿™æœŸé—´å¡é¡¿ä¸¥é‡**

**2ï¼‰ç«ç„°å›¾ Main**  
Main: è¡¨ç¤ºä¸»çº¿ç¨‹è¿è¡ŒçŠ¶å†µï¼ŒåŒ…æ‹¬ js çš„è®¡ç®—ä¸æ‰§è¡Œã€css æ ·å¼è®¡ç®—ã€Layout å¸ƒå±€ç­‰ç­‰ã€‚

å±•å¼€ Main,çº¢è‰²å€’ä¸‰è§’çš„ä¸º**Long Task**,æ‰§è¡Œæ—¶é•¿ 50ms å°±å±äºé•¿ä»»åŠ¡ï¼Œä¼šé˜»å¡é¡µé¢æ¸²æŸ“

**ä»å›¾ä¸­çœ‹åˆ°è®¡ç®—è¿‡ç¨‹çš„ Long Task æ‰§è¡Œæ—¶é—´ä¸º 35.45s, æ˜¯é€ æˆé¡µé¢å‡æ­»çš„åŸå› **

**3ï¼‰Summary ç»Ÿè®¡æ±‡æ€»é¢æ¿**  
Summary: è¡¨ç¤ºå„æŒ‡æ ‡æ—¶é—´å ç”¨ç»Ÿè®¡æŠ¥è¡¨

- Loading:Â  åŠ è½½æ—¶é—´
- Scripting:Â js è®¡ç®—æ—¶é—´
- Rendering:Â  æ¸²æŸ“æ—¶é—´
- Painting:Â  ç»˜åˆ¶æ—¶é—´
- Other:Â  å…¶ä»–æ—¶é—´
- Idle:Â  æµè§ˆå™¨é—²ç½®æ—¶é—´

**Scripting ä»£ç æ‰§è¡Œä¸º 35.9s**

![performance8.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/100da80ce95148cca9ac19286828e80c~tplv-k3u1fbpfcp-watermark.image?)

**æ‹¿ä»€ä¹ˆæ‹¯æ•‘ä½ ï¼Œæˆ‘çš„é¡µé¢**

<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38eb3e8c08974c5e92b48438758ba716~tplv-k3u1fbpfcp-watermark.image" alt="" width="30%" />

## å¬å”¤ Web Workerï¼Œå‡ºæ¥å§ç¥é¾™

![R-C (1).gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba759292d25f45fb8c28af3aa07444f9~tplv-k3u1fbpfcp-watermark.image?)

**ç¥é¾™ï¼Œæˆ‘æƒ³è®©é¡µé¢çš„è®¡ç®—å˜å¿«ï¼Œå¹¶ä¸”ä¸å¡é¡¿**

**Web Worker äº†è§£ä¸€ä¸‹ï¼š**

åœ¨ HTML5 çš„æ–°è§„èŒƒä¸­ï¼Œå®ç°äº† Web Worker æ¥å¼•å…¥ js çš„ â€œå¤šçº¿ç¨‹â€ æŠ€æœ¯, å¯ä»¥è®©æˆ‘ä»¬åœ¨é¡µé¢ä¸»è¿è¡Œçš„ js çº¿ç¨‹ä¸­ï¼ŒåŠ è½½è¿è¡Œå¦å¤–å•ç‹¬çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ª js çº¿ç¨‹

**ä¸€å¥è¯ï¼š Web Worker ä¸“é—¨å¤„ç†å¤æ‚è®¡ç®—çš„ï¼Œä»æ­¤è®©å‰ç«¯æ‹¥æœ‰åç«¯çš„è®¡ç®—èƒ½åŠ›**

## åœ¨ Vue ä¸­ ä½¿ç”¨ Web Worker

1ã€å®‰è£… worker-loader

```js
npm install worker-loader
```

2ã€ç¼–å†™ worker.js

```js
onmessage = function (e) {
  // onmessageè·å–ä¼ å…¥çš„åˆå§‹å€¼
  let sum = e.data;
  for (let i = 0; i < 200000; i++) {
    for (let i = 0; i < 10000; i++) {
      sum += Math.random();
    }
  }
  // å°†è®¡ç®—çš„ç»“æœä¼ é€’å‡ºå»
  postMessage(sum);
};
```

3ã€é€šè¿‡è¡Œå†… loader å¼•å…¥ worker.js

```js
import Worker from 'worker-loader!./worker';
```

4ã€æœ€ç»ˆä»£ç 

```js
<template>
    <div>
        <button @click="makeWorker">å¼€å§‹çº¿ç¨‹</button>
        <!--åœ¨è®¡ç®—æ—¶ å¾€inputè¾“å…¥å€¼æ—¶ æ²¡æœ‰å‘ç”Ÿå¡é¡¿-->
        <p><input type="text"></p>
    </div>
</template>

<script>
    import Worker from "worker-loader!./worker";

    export default {
        methods: {
            makeWorker() {
                // è·å–è®¡ç®—å¼€å§‹çš„æ—¶é—´
                let start = performance.now();
                // æ–°å»ºä¸€ä¸ªçº¿ç¨‹
                let worker = new Worker();
                // çº¿ç¨‹ä¹‹é—´é€šè¿‡postMessageè¿›è¡Œé€šä¿¡
                worker.postMessage(0);
                // ç›‘å¬messageäº‹ä»¶
                worker.addEventListener("message", (e) => {
                    // å…³é—­çº¿ç¨‹
                    worker.terminate();
                    // è·å–è®¡ç®—ç»“æŸçš„æ—¶é—´
                    let end = performance.now();
                    // å¾—åˆ°æ€»çš„è®¡ç®—æ—¶é—´
                    let durationTime = end - start;
                    console.log('è®¡ç®—ç»“æœ:', e.data);
                    console.log(`ä»£ç æ‰§è¡Œäº† ${durationTime} æ¯«ç§’`);
                });
            }
        },
    }
</script>
```

è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œåœ¨ input æ¡†è¾“å…¥å€¼ï¼Œé¡µé¢ä¸€ç›´æœªå‘ç”Ÿå¡é¡¿

![total.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d294d8e1a5bf4051acd935d5fb96671d~tplv-k3u1fbpfcp-watermark.image?)

## å¯¹æ¯”è¯•éªŒ

å¦‚æœç›´æ¥æŠŠä¸‹é¢è¿™æ®µä»£ç ç›´æ¥ä¸¢åˆ°ä¸»çº¿ç¨‹ä¸­ï¼Œè®¡ç®—è¿‡ç¨‹ä¸­é¡µé¢ä¸€ç›´å¤„äºå‡æ­»çŠ¶æ€ï¼Œinput æ¡†æ— æ³•è¾“å…¥

```js
let sum = 0;
for (let i = 0; i < 200000; i++) {
  for (let i = 0; i < 10000; i++) {
    sum += Math.random();
  }
}
```

## å‰æˆå·®ä¸å¤šäº†ï¼Œä¸Šç¡¬èœ

<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1da9b4626f5d4a81b901a215981bc263~tplv-k3u1fbpfcp-watermark.image" alt="" width="50%" />

**å¼€å¯å¤šçº¿ç¨‹ï¼Œå¹¶è¡Œè®¡ç®—**

å›åˆ°è¦è§£å†³çš„é—®é¢˜ï¼Œæ‰§è¡Œå¤šç§è¿ç®—æ—¶ï¼Œç»™æ¯ç§è¿ç®—å¼€å¯å•ç‹¬çš„çº¿ç¨‹ï¼Œçº¿ç¨‹è®¡ç®—å®Œæˆåè¦åŠæ—¶å…³é—­

**å¤šçº¿ç¨‹ä»£ç **

```js
<template>
    <div>
        <button @click="makeWorker">å¼€å§‹çº¿ç¨‹</button>
        <!--åœ¨è®¡ç®—æ—¶ å¾€inputè¾“å…¥å€¼æ—¶ æ²¡æœ‰å‘ç”Ÿå¡é¡¿-->
        <p><input type="text"></p>
    </div>
</template>

<script>
    import Worker from "worker-loader!./worker";

    export default {
        data() {
          // æ¨¡æ‹Ÿæ•°æ®
          let arr = new Array(100000).fill(1).map(() => Math.random()* 10000);
          let weightedList = new Array(100000).fill(1).map(() => Math.random()* 10000);
          let calcList = [
              {type: 'sum', name: 'æ€»å’Œ'},
              {type: 'average', name: 'ç®—æœ¯å¹³å‡'},
              {type: 'weightedAverage', name: 'åŠ æƒå¹³å‡'},
              {type: 'max', name: 'æœ€å¤§'},
              {type: 'middleNum', name: 'ä¸­ä½æ•°'},
              {type: 'min', name: 'æœ€å°'},
              {type: 'variance', name: 'æ ·æœ¬æ–¹å·®'},
              {type: 'popVariance', name: 'æ€»ä½“æ–¹å·®'},
              {type: 'stdDeviation', name: 'æ ·æœ¬æ ‡å‡†å·®'},
              {type: 'popStandardDeviation', name: 'æ€»ä½“æ ‡å‡†å·®'}
          ]
          return {
              workerList: [], // ç”¨æ¥å­˜å‚¨æ‰€æœ‰çš„çº¿ç¨‹
              calcList, // è®¡ç®—ç±»å‹
              arr, // æ•°æ®
              weightedList // åŠ æƒå› å­
          }
        },
        methods: {
            makeWorker() {
                this.calcList.forEach(item => {
                    let workerName = `worker${this.workerList.length}`;
                    let worker = new Worker();
                    let start = performance.now();
                    worker.postMessage({arr: this.arr, type: item.type, weightedList: this.weightedList});
                    worker.addEventListener("message", (e) => {
                        worker.terminate();

                        let tastName = '';
                        this.calcList.forEach(item => {
                            if(item.type === e.data.type) {
                                item.value = e.data.value;
                                tastName = item.name;
                            }
                        })

                        let end = performance.now();
                        let duration = end - start;
                        console.log(`å½“å‰ä»»åŠ¡: ${tastName}, è®¡ç®—ç”¨æ—¶: ${duration} æ¯«ç§’`);
                    });
                    this.workerList.push({ [workerName]: worker });
                })
            },
            clearWorker() {
                if (this.workerList.length > 0) {
                    this.workerList.forEach((item, key) => {
                        item[`worker${key}`].terminate && item[`worker${key}`].terminate(); // ç»ˆæ­¢æ‰€æœ‰çº¿ç¨‹
                    });
                }
            }
        },
        // é¡µé¢å…³é—­ï¼Œå¦‚æœè¿˜æ²¡æœ‰è®¡ç®—å®Œæˆï¼Œè¦é”€æ¯å¯¹åº”çº¿ç¨‹
        beforeDestroy() {
            this.clearWorker();
        },
    }
</script>
```

**worker.js**

```js
import { create, all } from 'mathjs';
const config = {
  number: 'BigNumber',
  precision: 20 // ç²¾åº¦
};
const math = create(all, config);

//åŠ 
const numberAdd = (arg1, arg2) => {
  return math.number(math.add(math.bignumber(arg1), math.bignumber(arg2)));
};
//å‡
const numberSub = (arg1, arg2) => {
  return math.number(math.subtract(math.bignumber(arg1), math.bignumber(arg2)));
};
//ä¹˜
const numberMultiply = (arg1, arg2) => {
  return math.number(math.multiply(math.bignumber(arg1), math.bignumber(arg2)));
};
//é™¤
const numberDivide = (arg1, arg2) => {
  return math.number(math.divide(math.bignumber(arg1), math.bignumber(arg2)));
};

// æ•°ç»„æ€»ä½“æ ‡å‡†å·®å…¬å¼
const popVariance = (arr) => {
  return Math.sqrt(popStandardDeviation(arr));
};

// æ•°ç»„æ€»ä½“æ–¹å·®å…¬å¼
const popStandardDeviation = (arr) => {
  let s,
    ave,
    sum = 0,
    sums = 0,
    len = arr.length;
  for (let i = 0; i < len; i++) {
    sum = numberAdd(Number(arr[i]), sum);
  }
  ave = numberDivide(sum, len);
  for (let i = 0; i < len; i++) {
    sums = numberAdd(
      sums,
      numberMultiply(numberSub(Number(arr[i]), ave), numberSub(Number(arr[i]), ave))
    );
  }
  s = numberDivide(sums, len);
  return s;
};

// æ•°ç»„åŠ æƒå…¬å¼
const weightedAverage = (arr1, arr2) => {
  // arr1: è®¡ç®—åˆ—ï¼Œarr2: é€‰æ‹©çš„æƒé‡åˆ—
  let s,
    sum = 0, // åˆ†å­çš„å€¼
    sums = 0, // åˆ†æ¯çš„å€¼
    len = arr1.length;
  for (let i = 0; i < len; i++) {
    sum = numberAdd(numberMultiply(Number(arr1[i]), Number(arr2[i])), sum);
    sums = numberAdd(Number(arr2[i]), sums);
  }
  s = numberDivide(sum, sums);
  return s;
};

// æ•°ç»„æ ·æœ¬æ–¹å·®å…¬å¼
const variance = (arr) => {
  let s,
    ave,
    sum = 0,
    sums = 0,
    len = arr.length;
  for (let i = 0; i < len; i++) {
    sum = numberAdd(Number(arr[i]), sum);
  }
  ave = numberDivide(sum, len);
  for (let i = 0; i < len; i++) {
    sums = numberAdd(
      sums,
      numberMultiply(numberSub(Number(arr[i]), ave), numberSub(Number(arr[i]), ave))
    );
  }
  s = numberDivide(sums, len - 1);
  return s;
};

// æ•°ç»„ä¸­ä½æ•°
const middleNum = (arr) => {
  arr.sort((a, b) => a - b);
  if (arr.length % 2 === 0) {
    //åˆ¤æ–­æ•°å­—ä¸ªæ•°æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°
    return numberDivide(numberAdd(arr[arr.length / 2 - 1], arr[arr.length / 2]), 2); //å¶æ•°ä¸ªå–ä¸­é—´ä¸¤ä¸ªæ•°çš„å¹³å‡æ•°
  } else {
    return arr[(arr.length + 1) / 2 - 1]; //å¥‡æ•°ä¸ªå–æœ€ä¸­é—´é‚£ä¸ªæ•°
  }
};

// æ•°ç»„æ±‚å’Œ
const sum = (arr) => {
  let sum = 0,
    len = arr.length;
  for (let i = 0; i < len; i++) {
    sum = numberAdd(Number(arr[i]), sum);
  }
  return sum;
};

// æ•°ç»„å¹³å‡å€¼
const average = (arr) => {
  return numberDivide(sum(arr), arr.length);
};

// æ•°ç»„æœ€å¤§å€¼
const max = (arr) => {
  let max = arr[0];
  for (let i = 0; i < arr.length; i++) {
    if (max < arr[i]) {
      max = arr[i];
    }
  }
  return max;
};

// æ•°ç»„æœ€å°å€¼
const min = (arr) => {
  let min = arr[0];
  for (let i = 0; i < arr.length; i++) {
    if (min > arr[i]) {
      min = arr[i];
    }
  }
  return min;
};

// æ•°ç»„æœ‰æ•ˆæ•°æ®é•¿åº¦
const count = (arr) => {
  let remove = ['', ' ', null, undefined, '-']; // æ’é™¤æ— æ•ˆçš„æ•°æ®
  return arr.filter((item) => !remove.includes(item)).length;
};

// æ•°ç»„æ ·æœ¬æ ‡å‡†å·®å…¬å¼
const stdDeviation = (arr) => {
  return Math.sqrt(variance(arr));
};

// æ•°å­—ä¸‰ä½åŠ é€—å·ï¼Œä¿ç•™ä¸¤ä½å°æ•°
const formatNumber = (num, pointNum = 2) => {
  if ((!num && num !== 0) || num == '-') return '--';
  let arr = (typeof num == 'string' ? parseFloat(num) : num).toFixed(pointNum).split('.');
  let intNum = arr[0].replace(/\d{1,3}(?=(\d{3})+(.\d*)?$)/g, '$&,');
  return arr[1] === undefined ? intNum : `${intNum}.${arr[1]}`;
};

onmessage = function (e) {
  let { arr, type, weightedList } = e.data;
  let value = '';
  switch (type) {
    case 'sum':
      value = formatNumber(sum(arr));
      break;
    case 'average':
      value = formatNumber(average(arr));
      break;
    case 'weightedAverage':
      value = formatNumber(weightedAverage(arr, weightedList));
      break;
    case 'max':
      value = formatNumber(max(arr));
      break;
    case 'middleNum':
      value = formatNumber(middleNum(arr));
      break;
    case 'min':
      value = formatNumber(min(arr));
      break;
    case 'variance':
      value = formatNumber(variance(arr));
      break;
    case 'popVariance':
      value = formatNumber(popVariance(arr));
      break;
    case 'stdDeviation':
      value = formatNumber(stdDeviation(arr));
      break;
    case 'popStandardDeviation':
      value = formatNumber(popStandardDeviation(arr));
      break;
  }

  // å‘é€æ•°æ®äº‹ä»¶
  postMessage({ type, value });
};
```

## 35s å˜æˆ 6s

**ä»åŸæ¥çš„ 35s å˜æˆäº†æœ€é•¿ 6sï¼Œå¹¶ä¸”è®¡ç®—è¿‡ç¨‹ä¸­å…¨ç¨‹æ— å¡é¡¿ï¼ŒYYDS**

![time1.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/498cca4446ce45fcb46c3b4f5f1800fe~tplv-k3u1fbpfcp-watermark.image?)

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adf28e0964754127a009fd3a3eb3385a~tplv-k3u1fbpfcp-watermark.image?" alt="src=http___img.soogif.com_n7sySW0OULhVlH5j7OrXHpbqEiM9hDsr.gif&refer=http___img.soogif.gif" width="35%" />

**æœ€ç»ˆçš„æ•ˆæœ**

![table.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18cd82fd70d84211b8317d69fa922713~tplv-k3u1fbpfcp-watermark.image?)

## åä¸‡æ¡å¤ª low äº†ï¼Œç™¾ä¸‡æ¡æ•°æ®ç©ä¸€ç©

```js
// ä¿®æ”¹ä¸Šæ–‡çš„æ¨¡æ‹Ÿæ•°æ®
let arr = new Array(1000000).fill(1).map(() => Math.random() * 10000);
let weightedList = new Array(1000000).fill(1).map(() => Math.random() * 10000);
```

æ—¶é—´æ˜æ˜¾ä¸Šæ¥äº†ï¼Œæœ€é•¿è¦ 50 å¤š s äº†ï¼Œæ²¡äº‹ç©ä¸€ç©ï¼Œå¼€å¿ƒå°±å¥½

![time3.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a58e9dbcc4ab4147a18c519bad9572e0~tplv-k3u1fbpfcp-watermark.image?)

## web worker æé«˜ Canvas è¿è¡Œé€Ÿåº¦

web worker é™¤äº†å•çº¯è¿›è¡Œè®¡ç®—å¤–ï¼Œè¿˜å¯ä»¥ç»“åˆ**ç¦»å± canvas**è¿›è¡Œç»˜å›¾ï¼Œæå‡ç»˜å›¾çš„æ¸²æŸ“æ€§èƒ½å’Œä½¿ç”¨ä½“éªŒ

**ç¦»å± canvas æ¡ˆä¾‹**

```js
<template>
    <div>
        <button @click="makeWorker">å¼€å§‹ç»˜å›¾</button>
        <canvas id="myCanvas" width="300" height="150"></canvas>
    </div>
</template>

<script>
    import Worker from "worker-loader!./worker";
    export default {
        methods: {
            makeWorker() {
                let worker = new Worker();
                let htmlCanvas = document.getElementById("myCanvas");
                // ä½¿ç”¨canvasçš„transferControlToOffscreenå‡½æ•°è·å–ä¸€ä¸ªOffscreenCanvaså¯¹è±¡
                let offscreen = htmlCanvas.transferControlToOffscreen();
                // æ³¨æ„ï¼šç¬¬äºŒä¸ªå‚æ•°ä¸èƒ½çœç•¥
                worker.postMessage({canvas: offscreen}, [offscreen]);
            }
        }
    }
</script>
```

**worker.js**

```js
onmessage = function (e) {
  // ä½¿ç”¨OffscreenCanvasï¼ˆç¦»å±Canvasï¼‰
  let canvas = e.data.canvas;
  // è·å–ç»˜å›¾ä¸Šä¸‹æ–‡
  let ctx = canvas.getContext('2d');
  // ç»˜åˆ¶ä¸€ä¸ªåœ†å¼§
  ctx.beginPath(); // å¼€å¯è·¯å¾„
  ctx.arc(150, 75, 50, 0, Math.PI * 2);
  ctx.fillStyle = '#1989fa'; //è®¾ç½®å¡«å……é¢œè‰²
  ctx.fill(); //å¼€å§‹å¡«å……
  ctx.stroke();
};
```

**æ•ˆæœï¼š**

<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/097856c80b2a4ad6824c8c581c1f279c~tplv-k3u1fbpfcp-watermark.image?" alt="cricle.gif" width="50%" />

**ç¦»å± canvas çš„ä¼˜åŠ¿**

1ã€å¯¹äºå¤æ‚çš„ canvas ç»˜å›¾ï¼Œå¯ä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹

2ã€ç”±äºè¿™ç§è§£è€¦ï¼ŒOffscreenCanvas çš„æ¸²æŸ“ä¸ DOM å®Œå…¨åˆ†ç¦»äº†å¼€æ¥ï¼Œå¹¶ä¸”æ¯”æ™®é€š Canvas é€Ÿåº¦æå‡äº†ä¸€äº›

## Web Worker çš„é™åˆ¶

1ã€åœ¨ Worker çº¿ç¨‹çš„è¿è¡Œç¯å¢ƒä¸­æ²¡æœ‰ window å…¨å±€å¯¹è±¡ï¼Œä¹Ÿæ— æ³•è®¿é—® DOM å¯¹è±¡

2ã€Worker ä¸­åªèƒ½è·å–åˆ°éƒ¨åˆ†æµè§ˆå™¨æä¾›çš„ APIï¼Œå¦‚`å®šæ—¶å™¨`ã€`navigator`ã€`location`ã€`XMLHttpRequest`ç­‰

3ã€ç”±äºå¯ä»¥è·å–`XMLHttpRequest` å¯¹è±¡ï¼Œå¯ä»¥åœ¨ Worker çº¿ç¨‹ä¸­æ‰§è¡Œ`ajax`è¯·æ±‚

4ã€æ¯ä¸ªçº¿ç¨‹è¿è¡Œåœ¨å®Œå…¨ç‹¬ç«‹çš„ç¯å¢ƒä¸­ï¼Œéœ€è¦é€šè¿‡`postMessage`ã€ `message`äº‹ä»¶æœºåˆ¶æ¥å®ç°çš„çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡

## è®¡ç®—æ—¶é•¿ è¶…è¿‡å¤šé•¿æ—¶é—´ é€‚åˆç”¨ Web Worker

**åŸåˆ™ä¸Šï¼Œè¿ç®—æ—¶é—´è¶…è¿‡ 50ms ä¼šé€ æˆé¡µé¢å¡é¡¿ï¼Œå±äº Long taskï¼Œè¿™ç§æƒ…å†µå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ Web Worker**

ä½†è¿˜è¦å…ˆè€ƒè™‘`é€šä¿¡æ—¶é•¿`çš„é—®é¢˜

å‡å¦‚ä¸€ä¸ªè¿ç®—æ‰§è¡Œæ—¶é•¿ä¸º 100ms, ä½†æ˜¯é€šä¿¡æ—¶é•¿ä¸º 300ms, ç”¨äº† Web Worker å¯èƒ½ä¼šæ›´æ…¢

<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/874f81857de64876808f1a3868770246~tplv-k3u1fbpfcp-watermark.image?" alt="face.jpg" width="20%" />

### é€šä¿¡æ—¶é•¿

æ–°å»ºä¸€ä¸ª web worker æ—¶, æµè§ˆå™¨ä¼šåŠ è½½å¯¹åº”çš„ worker.js èµ„æº

**ä¸‹å›¾ä¸­çš„ Time æ˜¯è¿™ä¸ª js èµ„æºçš„åŠ è½½æ—¶é•¿**

![load.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b3f1e0b00b34a35813dd06f1354ee18~tplv-k3u1fbpfcp-watermark.image?)

**æœ€ç»ˆæ ‡å‡†ï¼š**

**è®¡ç®—çš„è¿ç®—æ—¶é•¿ - é€šä¿¡æ—¶é•¿ > 50msï¼Œæ¨èä½¿ç”¨ Web Worker**

## åœºæ™¯è¡¥å……è¯´æ˜

**é‡åˆ°å¤§æ•°æ®ï¼Œç¬¬ä¸€ååº”: ä¸ºä»€ä¹ˆä¸è®©åç«¯å»è®¡ç®—å‘¢ï¼Ÿ**

è¿™é‡Œæ¯”è¾ƒç‰¹æ®Šï¼Œè¡¨æ ¼ 4000 è¡Œï¼Œ25 åˆ—  
1ï¼‰ç”¨æˆ·å¯ä»¥å¯¹è¡¨æ ¼è¿›è¡Œçµæ´»æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤ä»»ä½•è¡Œæˆ–åˆ—ï¼Œé€‰æ‹©æˆ–å‰”é™¤ä»»æ„è¡Œ  
2ï¼‰ç”¨æˆ·å¯ä»¥çµæ´»é€‰æ‹©è¿ç®—çš„ç±»å‹ï¼Œè®¡ç®—ä¸€ä¸ªæˆ–å¤šä¸ª

å³ä¾¿æ˜¯è®©åç«¯è®¡ç®—ï¼Œéœ€è¦æŠŠå¤§é‡æ•°æ®ä¼ ç»™åç«¯ï¼Œè®¡ç®—å¥½å†è¿”å›ï¼Œè¿™ä¸ªæ—¶é—´ä¹Ÿä¸çŸ­ï¼Œè¿˜å¯èƒ½å‡ºç°ç”¨æˆ·é¢‘ç¹æ“ä½œï¼Œæ¥å£æ•°æ®è¢«è¦†ç›–ç­‰æƒ…å†µ

## github ä»“åº“

æƒ³åŠ¨æ‰‹ç©ä¸€ç©çš„å°ä¼™ä¼´ï¼Œå¯ä»¥ä»[**github ä»“åº“**](https://github.com/xy-sea/blog/tree/dev/web-worker)ä¸‹è½½

**ç¤ºä¾‹æ¼”ç¤º**

![webworker.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47bf26f3a4ca459ea360946d7a659647~tplv-k3u1fbpfcp-watermark.image?)

## æ€»ç»“

**Web Worker ä¸ºå‰ç«¯å¸¦æ¥äº†åç«¯çš„è®¡ç®—èƒ½åŠ›ï¼Œæ‰©å¤§äº†å‰ç«¯çš„ä¸šåŠ¡è¾¹ç•Œ**

å¯ä»¥å®ç°ä¸»çº¿ç¨‹ä¸å¤æ‚è®¡è¿ç®—çº¿ç¨‹çš„åˆ†ç¦»ï¼Œä»è€Œå‡è½»äº†å› å¤§é‡è®¡ç®—è€Œé€ æˆ UI é˜»å¡çš„æƒ…å†µ

å¹¶ä¸”æ›´å¤§ç¨‹åº¦åœ°åˆ©ç”¨äº†ç»ˆç«¯ç¡¬ä»¶çš„æ€§èƒ½

![R-C.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6fe05af53f14760b7abb55be9f5de0f~tplv-k3u1fbpfcp-watermark.image?)

## å‚è€ƒé“¾æ¥

[JavaScript ä¸­çš„å¤šçº¿ç¨‹ -- Web Worker](https://zhuanlan.zhihu.com/p/25184390)  
[OffscreenCanvas-ç¦»å± canvas ä½¿ç”¨è¯´æ˜](https://blog.csdn.net/netcy/article/details/103781610)
